---
title: "Associations Between Neighbourhood Socioeconomic Status and Road Traffic Injury Risk in Urban Areas of British Columbia - R Code"
author: "Michael Branion-Calles"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
editor_options: 
  chunk_output_type: console
---

# Load libraries and functions

```{r,message=FALSE}
 # install.packages("INLA",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE) 
tictoc::tic()

library(INLA)          # For fitting integrated nested Laplace approximation (INLA) models
library(tidyverse)     # For data manipulation and visualization
library(sp)            # For spatial data handling
library(spdep)         # For spatial dependence analysis
library(flextable)     # For creating flexible tables
library(RColorBrewer)  # For color palettes
library(rcartocolor)   # For additional color palettes
library(cowplot)       # For combining plots
library(janitor)       # For cleaning data
library(broom)

# Functions ---------------------------------------------------------------

# Standardize a numeric vector
my_std <- function(x) { (x - mean(x,na.rm=TRUE)) / sd(x,na.rm = TRUE)}

# Fit a BYM2 model using INLA
fit_bym2 <- function(table,
                     outcome_var,
                     interest_var,
                     distribution = "poisson",
                     formula_terms = NULL,
                     prec_param =  c(1, 0.001),
                     phi_param = c(0.5, 0.5)) {

# Define priors for precision and phi
    prior <- list(
  prec = list(
    prior = "pc.prec",
    param = prec_param),
  phi = list(
    prior = "pc",
    param = phi_param)
  )
    
  # Construct the INLA formula based on input parameters
  if (is.null(formula_terms)) {
    inla_formula <- as.formula(paste(outcome_var, "~", interest_var, "+ f(ui, model = 'bym2', graph = g, hyper = prior, adjust.for.con.comp = TRUE,
constr = TRUE, scale.model = TRUE)"))
  } else {
    inla_formula <- as.formula(paste(outcome_var, "~", interest_var, "+", formula_terms, "+ f(ui, model = 'bym2', graph = g, hyper = prior, adjust.for.con.comp = TRUE,
constr = TRUE, scale.model = TRUE)"))
  }
    
    
    
#adjust.for.con.comp = TRUE, scale.model = TRUE:  assigns one intercept to each region in addition to using a sum-to-zero constraint for each connected region. By adding an intercept for each region, we infer that the baseline prevalence is different in the disconnected regions.
#The spatial random effects can be interpreted as the area-specific deviation from the region-specific risk in this case. The intercepts for the disconnected regions need to be explicitly specified in INLA:

  
  # Fit the INLA model with BYM2 prior
fit <- inla(inla_formula,
              data = table,
              family = distribution,
              control.compute = list(dic = TRUE, waic = TRUE,cpo=TRUE,config=TRUE),
              control.predictor = list(compute = TRUE),
              verbose = FALSE)
  
  # Return the INLA model object
  return(fit)
}

# Tidy up INLA model fixed effects results
tidy_inla <- function(fixed_effects, exponentiate = FALSE, sigfig =NULL) {
  # Create a tidy data frame
  tidy_results <- fixed_effects %>%
    dplyr::rename(estimate = 'mean',
                  std.error = 'sd',
                  lower_ci = '0.025quant',
                  upper_ci = '0.975quant')
  
  if (exponentiate) {
    tidy_results <- tidy_results %>%
      mutate(estimate = exp(estimate),
             lower_ci = exp(lower_ci),
             upper_ci = exp(upper_ci))
  }
  
  if (!is.null(sigfig)) {
    tidy_results <- tidy_results %>%
      mutate(estimate = signif(estimate, sigfig),
             std.error = signif(std.error, sigfig),
             lower_ci = signif(lower_ci, sigfig),
             upper_ci = signif(upper_ci, sigfig))
  }
  
  return(tidy_results)
}

# prs <- function(x,n.dig = 2){
#   
#   formatC(round(x,n.dig), format='f', big.mark = ",",digits = n.dig)
#   
# }

cma_models <- function(cma_data, cma_name, outcome, deprivation_indicator,distribution = "poisson") {
  
  ###### Spatial Models #####  
  
  ### 1: Unadjusted
  
  print("Fit unadjusted")
  
  m1 <- fit_bym2(cma_data, outcome, deprivation_indicator,distribution)
  m1_fe <- tidy_inla(m1$summary.fixed, exponentiate = TRUE, sigfig =3) %>%
    mutate(
      `IRR (95% CI)` = paste0(estimate, " (", lower_ci, ", ", upper_ci, ")"),
      variable = row.names(.)
    ) %>%
    select(variable, `IRR (95% CI)`)
  
    print("Fit adjusted by road length")

  ### 2: Adjusted by Road Length
  m2 <- fit_bym2(cma_data, outcome, deprivation_indicator, formula_terms = "ln_roads_km_c",distribution)
  m2_fe <- tidy_inla(m2$summary.fixed, exponentiate = TRUE, sigfig =3) %>%
    mutate(
      `IRR (95% CI)` = paste0(estimate, " (", lower_ci, ", ", upper_ci, ")"),
      variable = row.names(.)
    ) %>%
    select(variable, `IRR (95% CI)`)
  
  ### 3: Adjusted by Road Length and other variables
  m3 <- fit_bym2(cma_data, outcome, deprivation_indicator, 
                  formula_terms = "ln_roads_km_c + roads_prop_highway_arterial_z + ale_index_z + canbics_index_z + population_100_c",distribution)
  m3_fe <- tidy_inla(m3$summary.fixed, exponentiate = TRUE, sigfig =3) %>%
    mutate(
      `IRR (95% CI)` = paste0(estimate, " (", lower_ci, ", ", upper_ci, ")"),
      variable = row.names(.)
    ) %>%
    select(variable, `IRR (95% CI)`)

  l <- list(m1, m2, m3)
  names(l) <- c("Unadjusted","Adjusted1","Adjusted2")
  
      print("Fit adjusted by road length and covariates")


  # Compile results into a tibble
  tibble(
    cma = cma_name,
    model_type = c("unadjusted", "adjusted_minimal", "adjusted_full"),
    models = l,
    fixed_effects = list(m1_fe, m2_fe, m3_fe)
  )
         
}


# Clean and format fixed effects results from models
clean_fixed_effects <- function(cma_model_object){
  
  cma_model_object %>% 
    bind_rows(,.id="model_type") %>% 
    mutate(model_type = case_when(model_type == "1"~"Unadjusted IRR (95% CI)",
                                  model_type == "2"~"Minimally Adjusted IRR (95% CI)",
                                  model_type == "3"~"Fully Adjusted IRR (95% CI)",
    )) %>% 
    pivot_wider(id_cols = variable,names_from = model_type,values_from = `IRR (95% CI)` ) %>% 
    mutate(variable = case_when(variable == "ln_roads_km_c" ~"Log(Total KMs of Road)",
                                variable == "roads_prop_highway_arterial_z" ~ "% of roads classifed as Arterial/Highway (SD)",
                                variable == "ale_index_z" ~ "Canadian Active Living Enrivonment Index (SD)",
                                variable == "canbics_index_z" ~ "Canadian Bikeway Safety and Comfort Index (SD)",
                                variable == "population_100_c" ~ "Population (100)",
                                TRUE ~ variable
                                
    )) 
  
}


assign_nearest_neighbors <- function(nb_object, sp_object,make_symmetrical=TRUE) {
    # Calculate centroids for isolated polygons
  centroids <- coordinates(sp_object)  # If using sp
  
  centroids_nn <- knearneigh(centroids, k = 1)

  # Get the list of neighbors
  zero_nb_logical <- sapply(nb_object, function(x) x[1] ==0)
  
  zero_nb_indices <- which(zero_nb_logical)
  
  zero_nn <- centroids_nn$nn[zero_nb_indices, ]
  
  for(i in 1:length(zero_nn)){
    
    nb_object[zero_nb_indices[i]] <- zero_nn[i]
  }
  
  if(make_symmetrical==TRUE){
    
    nb_object <- make.sym.nb(nb_object)
  }
  
  
  return(nb_object)
}

create_descriptive_table <- function(sf_obj, selected_vars) {
  sf_obj %>%
    # Drop geometry and select only the specified variables
    st_drop_geometry() %>%
    select(all_of(selected_vars)) %>%
    # Gather descriptive statistics for each variable
    summarise(across(everything(), list(
      sum = ~sum(.x, na.rm = TRUE),
      mean = ~mean(.x, na.rm = TRUE),
      sd = ~sd(.x, na.rm = TRUE),
      min = ~min(.x, na.rm = TRUE),
      max = ~max(.x, na.rm = TRUE),
      n = ~sum(!is.na(.x)|is.na(.x)),       # Count non-NA values
      missing = ~sum(is.na(.x)),
      n_zero = ~sum(.x==0,na.rm=TRUE)# Count 0 values
    ), .names = "{.col}-{.fn}")) %>%
    # Pivot longer to have each variable as its own row
    pivot_longer(everything(), 
                 names_to = c("variable", ".value"),
                 names_sep = "-") %>%
    # Add a column to identify the sf object
    # Reorder columns for better readability
    select(variable, n, sum, mean, sd, min, max, , missing,n_zero)
}

```

# Load Data and Clean

```{r,message=FALSE}
# Load and clean data -----------------------------------------------------

cma_name <- cancensus::get_census("CA21",
                                  level = "CMA",
                                  regions = list(PR=59)) %>% 
  rename(CMA_UID = GeoUID,
         `CMA Name` = `Region Name`,
         cma_population = Population) %>% 
  arrange(desc(cma_population)) %>% 
  select(CMA_UID, Type, `CMA Name`,cma_population) %>% 
  mutate(`CMA Name` = str_remove_all(`CMA Name`," \\(B\\)|\\(K\\)|\\(D\\)")) %>%
  clean_names() %>% 
  mutate(cma_name = stringr::str_trim(cma_name,"right"))


# Read spatial data for dissemination areas in British Columbia
bc_da <- st_read(
  "C:/Users/micha/Documents/GitHub/Area-Level-Deprivation-Traffic-Injury/Processed Data/da_v3_2021.gpkg"
) %>%
  # Join the census data with the spatial data
  left_join(cma_name, by = join_by(cma_uid)) %>%
  filter(!is.na(cma_name)) %>% 
  mutate(
    population_100 = population/100,
    
    population_100_c = scale(population_100, scale = FALSE),    # Convert road lengths from meters to kilometers
    total_roads_km = total_roads_m / 1000,
    
    n_casualty_claims_rate = n_casualty_claims/total_roads_km*10,
    n_pedestrian_casualty_claims_rate = n_pedestrian_casualty_claims/total_roads_km*10,
    n_cyclist_casualty_claims_rate = n_cyclist_casualty_claims/total_roads_km*10,

    # Calculate the proportion of roads that are highways or arterials
    roads_prop_highway_arterial = (highway_m + arterial_m) / total_roads_m,
    # Standardize the proportion of highways and arterials
    roads_prop_highway_arterial_z = my_std(roads_prop_highway_arterial),
    # Log-transform the total length of roads in kilometers
    ln_roads_km = ifelse(total_roads_km ==0, NA,log(total_roads_km)),
    ln_roads_km_c = scale(ln_roads_km, scale = FALSE),
    # Calculate the casualty claims rate by total road kilometers
    casualty_claims_rate = n_casualty_claims / total_roads_km * 10,
    # Calculate the cyclist casualty claims rate by total road kilometers
    cyclist_casualty_claims_rate = n_cyclist_casualty_claims / total_roads_km * 10,
    # Calculate the pedestrian casualty claims rate by total road kilometers
    pedestrian_casualty_claims_rate = n_pedestrian_casualty_claims / total_roads_km * 10,
    # Convert journey-to-work total from meters to kilometers
    jtw_total_100 = jtw_total / 100,
    # Standardize the journey-to-work total
    jtw_total_z = my_std(jtw_total),
    # Calculate the proportion of journey-to-work trips that are motor vehicle-related
    jtw_prop_mv = ((jtw_driver + jtw_passenger) / jtw_total),
    # Calculate the proportion of non-motor vehicle journey-to-work trips
    jtw_prop_non_mv = (1 - jtw_prop_mv),
    # Standardize the proportion of non-motor vehicle trips
    jtw_prop_non_mv_z = my_std(jtw_prop_non_mv),
    # Adjust and scale the remote index for visualization
    remote_index_2 = (1 - remote_index) * 100,
    # Log-transform the adjusted remote index
    ln_remote_index = log(remote_index_2),
    # Standardize the VANDIX index
    vandix_z = my_std(vandix),
    # Convert VANDIX quintile to descriptive categories
    vandix_quintile = vandix_quintile %>% as.character(),
    vandix_quintile = case_when(
      vandix_quintile == "1" ~ "1 - Least Deprived",
      vandix_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ vandix_quintile
    ),
    # Convert educational attainment quintile to descriptive categories
    no_highschool_quintile = no_highschool_quintile %>% as.character(),
    no_highschool_quintile = case_when(
      no_highschool_quintile == "1" ~ "1 - Least Deprived",
      no_highschool_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ no_highschool_quintile
    ),
    # Convert unemployment rate quintile to descriptive categories
    unemployment_rate_quintile = unemployment_rate_quintile %>% as.character(),
    unemployment_rate_quintile = case_when(
      unemployment_rate_quintile == "1" ~ "1 - Least Deprived",
      unemployment_rate_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ unemployment_rate_quintile
    ),
    # Convert university degree quintile to descriptive categories
    university_degree_quintile = university_degree_quintile %>% as.character(),
    university_degree_quintile = case_when(
      university_degree_quintile == "1" ~ "1 - Least Deprived",
      university_degree_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ university_degree_quintile
    ),
    # Convert lone-parent family quintile to descriptive categories
    lone_parent_fam_quintile = lone_parent_fam_quintile %>% as.character(),
    lone_parent_fam_quintile = case_when(
      lone_parent_fam_quintile == "1" ~ "1 - Least Deprived",
      lone_parent_fam_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ lone_parent_fam_quintile
    ),
    # Convert average household income quintile to descriptive categories
    hh_avg_income_quintile = hh_avg_income_quintile %>% as.character(),
    hh_avg_income_quintile = case_when(
      hh_avg_income_quintile == "1" ~ "1 - Least Deprived",
      hh_avg_income_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ hh_avg_income_quintile
    ),
    # Convert home ownership quintile to descriptive categories
    home_owner_quintile = home_owner_quintile %>% as.character(),
    home_owner_quintile = case_when(
      home_owner_quintile == "1" ~ "1 - Least Deprived",
      home_owner_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ home_owner_quintile
    ),
    # Convert participation rate quintile to descriptive categories
    participation_rate_quintile = participation_rate_quintile %>% as.character(),
    participation_rate_quintile = case_when(
      participation_rate_quintile == "1" ~ "1 - Least Deprived",
      participation_rate_quintile == "5" ~ "5 - Most Deprived",
      TRUE ~ participation_rate_quintile
    ),
    # Convert CANBICS class to descriptive categories
    canbics_class_c = case_when(
      canbics_class == 1 | canbics_class == "2" ~ "1 - Low",
      canbics_class == 5 | canbics_class == "4" ~ "3 - High",
      canbics_class == 3 ~ "2 - Medium"
    ),
    # Standardize the CANBICS index
    canbics_index_z = my_std(canbics_index),
    
    # Convert ALE class to descriptive categories
    ale_class_c = case_when(
      ale_class == 1 | ale_class == "2" ~ "1 - Low",
      ale_class == 5 | ale_class == "4" ~ "3 - High",
      ale_class == 3 ~ "2 - Medium"
    ),
    # Standardize the ALE index
    ale_index_z = my_std(ale_index),
    # Calculate VanDIX 
    z_no_highschool_prevalance_w = scale(no_highschool_prevalance),
    z_university_degree_prevalance_w = scale(university_degree_prevalance * -1),
    z_unemployment_rate_w = scale(unemployment_rate),
    z_lone_parent_fam_prevalence_w = scale(lone_parent_fam_prevalence),
    z_hh_avg_income_w = scale(hh_avg_income * -1),
    z_home_owner_prevalence_w = scale(home_owner_prevalence * -1),
    z_participation_rate_w = scale(participation_rate * -1),
    # Compute VanDIX (Area Level Deprivation Index) score
    vandix = as.numeric(
      z_hh_avg_income_w * 0.089 +
        z_home_owner_prevalence_w * 0.089 +
        z_lone_parent_fam_prevalence_w * 0.143 +
        z_no_highschool_prevalance_w * 0.25 +
        z_university_degree_prevalance_w * 0.179 +
        z_unemployment_rate_w * 0.214 +
        z_participation_rate_w * 0.036
    ),
    vandix_z_c = case_when(vandix_z< -5 ~ "<-5",
                                    vandix_z>= -5 & vandix_z< -4 ~"-5 - -4",
                                    vandix_z>= -4 & vandix_z < -3 ~"-4 - -3",
                                    vandix_z>= -3 & vandix_z < -2 ~"-3 - -2",
                                    vandix_z>= -2 & vandix_z < -1 ~"-2 - -1",
                                    vandix_z>= -1 & vandix_z < 0 ~"-1 - 0",
                                    vandix_z>= 0 & vandix_z < 1 ~"0 - 1",
                                    vandix_z>= 1 & vandix_z<2 ~"1 - 2",
                                    vandix_z>= 2 & vandix_z<3 ~"2 - 3",
                                    vandix_z>= 3 & vandix_z<4 ~"3 - 4",
                                    vandix_z>= 4 & vandix_z<5 ~"4 - 5",
                                    vandix_z >= 5 ~ ">5",
      ),
      vandix_z_c  = factor(vandix_z_c,levels = c("<-5","-5 - -4","-4 - -3" , "-3 - -2" , "-2 - -1" , "-1 - 0",  "0 - 1" ,  "1 - 2",  "2 - 3", "3 - 4","4 - 5",">5"))
  ) %>% 
    mutate(region_name = case_when(
    cma_name %in% c("Prince Rupert", "Terrace") ~ "Northwest",
    cma_name %in% c("Fort St. John", "Dawson Creek", "Prince George", "Quesnel", "Williams Lake") ~ "North Central",
    cma_name %in% c("Kamloops", "Salmon Arm") ~ "Kamloops-Salmon Arm",
    cma_name %in% c("Vernon", "Kelowna", "Penticton") ~ "Okanagan",
    cma_name %in% c("Cranbrook", "Nelson", "Trail") ~ "Southeast",
    cma_name %in% c("Vancouver", "Squamish") ~ "Vancouver-Squamish",
    cma_name %in% c("Abbotsford - Mission", "Chilliwack") ~ "Fraser Valley",
    cma_name %in% c("Campbell River", "Courtenay", "Port Alberni", "Parksville", "Nanaimo", "Ladysmith", "Duncan","Powell River") ~ "Central Island-Powell River",
    cma_name == "Victoria" ~ "Victoria",
    TRUE ~ NA_character_  # Handle cases where cma_name doesn't match any of the specified values
  ))


#split data into list of CMAs
bc_cma <- bc_da %>% 
  split(.$cma_name)

bc_region <- bc_da %>% 
  split(.$region_name)

cma_pop <- bc_da %>%
  st_drop_geometry() %>% 
  group_by(cma_name) %>% 
  summarise(n_da = n(),
            population = sum(population,na.rm=TRUE)) %>% 
  arrange(desc(population))

region_pop <- bc_da %>%
  st_drop_geometry() %>% 
  group_by(region_name) %>% 
  summarise(n_da = n(),
            population = sum(population,na.rm=TRUE)) %>% 
  arrange(desc(population))



region_descriptives <- map(
  bc_region,
  create_descriptive_table,
  c(
    "n_claims",
    "n_casualty_claims",
    "n_cyclist_claims",
    "n_cyclist_casualty_claims",
    "n_pedestrian_claims",
    "n_pedestrian_casualty_claims",
    "population",
    "total_roads_km",
    "roads_prop_highway_arterial",
    "no_highschool_prevalance",
    "unemployment_rate",
    "hh_avg_income",
    "participation_rate",
    "university_degree_prevalance",
    "lone_parent_fam_prevalence",
    "home_owner_prevalence",
    "vandix",
    "roads_prop_highway_arterial",
    "ale_index",
    "canbics_index"
  )
) %>% 
  bind_rows(.id = "region") %>% 
  arrange(desc(n)) %>% 
  mutate(p_zero = n_zero/n*100)


cma_descriptives <- map(
  bc_cma,
  create_descriptive_table,
  c(
    "n_claims",
    "n_casualty_claims",
    "n_cyclist_claims",
    "n_cyclist_casualty_claims",
    "n_pedestrian_claims",
    "n_pedestrian_casualty_claims",
    "population",
    "total_roads_km",
    "roads_prop_highway_arterial",
    "no_highschool_prevalance",
    "unemployment_rate",
    "hh_avg_income",
    "participation_rate",
    "university_degree_prevalance",
    "lone_parent_fam_prevalence",
    "home_owner_prevalence",
    "vandix",
    "roads_prop_highway_arterial",
    "ale_index",
    "canbics_index"
  )
) %>% 
  bind_rows(.id = "cma") %>% 
  arrange(desc(n)) %>% 
  mutate(p_zero = n_zero/n*100)

```



# Spatial Models

## Vancouver - Squamish

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

vancouver_sf <- bc_da %>% 
  filter(region_name == "Vancouver-Squamish") 

 region_descriptives %>% 
   filter(region == "Vancouver-Squamish") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = vancouver_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = vancouver_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = vancouver_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

vancouver_sp <- as(vancouver_sf, "Spatial")
vancouver_sp$ui <- 1:nrow(vancouver_sp@data)

coords <- coordinates(vancouver_sp)
vancouver_nb <- poly2nb(vancouver_sp, queen = TRUE)

vancouver_nb

#assign nearest neighbour for no links

vancouver_nb <- assign_nearest_neighbors(vancouver_nb,vancouver_sp)

plot(vancouver_sp, border = grey(0.5))
plot(vancouver_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(vancouver_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(vancouver_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(vancouver_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(vancouver_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("vancouver.adj", vancouver_nb)
g <- inla.read.graph(filename = "vancouver.adj")


# Model Set 1: Total Casualty Claim Crashes

van_models_1 <- cma_models(vancouver_sp@data, "Vancouver-Squamish", "n_casualty_claims", "vandix_z") 

van_all <- clean_fixed_effects(van_models_1$fixed_effects)

map(van_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

van_models_2 <- cma_models(vancouver_sp@data,"Vancouver-Squamish","n_cyclist_casualty_claims","vandix_z") 

van_cyclist <- clean_fixed_effects(van_models_2$fixed_effects)

map(van_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

van_models_3 <- cma_models(vancouver_sp@data,"Vancouver-Squamish","n_pedestrian_casualty_claims","vandix_z") 

van_pedestrian <- clean_fixed_effects(van_models_3$fixed_effects)

map(van_models_3$models,~summary(.x))

van_results <- bind_rows(van_all %>% mutate(Region = "Vancouver-Squamish",Outcome = "All Injury Claims"),
                         van_cyclist %>% mutate(Region = "Vancouver-Squamish",Outcome = "Cyclist Injury Claims"),
                         van_pedestrian %>% mutate(Region = "Vancouver-Squamish",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())


```

## Victoria

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

victoria_sf <- bc_da %>% 
  filter(region_name == "Victoria") 

 region_descriptives %>% 
   filter(region == "Victoria") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = victoria_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = victoria_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = victoria_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

victoria_sp <- as(victoria_sf, "Spatial")
victoria_sp$ui <- 1:nrow(victoria_sp@data)

coords <- coordinates(victoria_sp)
victoria_nb <- poly2nb(victoria_sp, queen = TRUE)

victoria_nb

#assign nearest neighbour for no links

# victoria_nb <- assign_nearest_neighbors(victoria_nb,victoria_sp)

plot(victoria_sp, border = grey(0.5))
plot(victoria_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(victoria_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(victoria_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(victoria_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(victoria_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("victoria.adj", victoria_nb)
g <- inla.read.graph(filename = "victoria.adj")


# Model Set 1: Total Casualty Claim Crashes

victoria_models_1 <- cma_models(victoria_sp@data, "Victoria", "n_casualty_claims", "vandix_z") 

victoria_all <- clean_fixed_effects(victoria_models_1$fixed_effects)

map(victoria_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

victoria_models_2 <- cma_models(victoria_sp@data,"Victoria","n_cyclist_casualty_claims","vandix_z") 

victoria_cyclist <- clean_fixed_effects(victoria_models_2$fixed_effects)

map(victoria_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

victoria_models_3 <- cma_models(victoria_sp@data,"Victoria","n_pedestrian_casualty_claims","vandix_z") 

victoria_pedestrian <- clean_fixed_effects(victoria_models_3$fixed_effects)

map(victoria_models_3$models,~summary(.x))

victoria_results <- bind_rows(victoria_all %>% mutate(Region = "Victoria",Outcome = "All Injury Claims"),
                         victoria_cyclist %>% mutate(Region = "Victoria",Outcome = "Cyclist Injury Claims"),
                         victoria_pedestrian %>% mutate(Region = "Victoria",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())
```


## Central Island - Powell River

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

nanaimo_sf <- bc_da %>% 
  filter(region_name == "Central Island-Powell River") 

 region_descriptives %>% 
   filter(region == "Central Island-Powell River") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = nanaimo_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = nanaimo_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = nanaimo_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

nanaimo_sp <- as(nanaimo_sf, "Spatial")
nanaimo_sp$ui <- 1:nrow(nanaimo_sp@data)

coords <- coordinates(nanaimo_sp)
nanaimo_nb <- poly2nb(nanaimo_sp, queen = TRUE)

nanaimo_nb

#assign nearest neighbour for no links

nanaimo_nb <- assign_nearest_neighbors(nanaimo_nb,nanaimo_sp)

plot(nanaimo_sp, border = grey(0.5))
plot(nanaimo_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(nanaimo_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(nanaimo_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(nanaimo_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(nanaimo_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("nanaimo.adj", nanaimo_nb)
g <- inla.read.graph(filename = "nanaimo.adj")


# Model Set 1: Total Casualty Claim Crashes

nanaimo_models_1 <- cma_models(nanaimo_sp@data, "Central Island-Powell River", "n_casualty_claims", "vandix_z") 

nanaimo_all <- clean_fixed_effects(nanaimo_models_1$fixed_effects)

map(nanaimo_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

nanaimo_models_2 <- cma_models(nanaimo_sp@data,"Central Island-Powell River","n_cyclist_casualty_claims","vandix_z") 

nanaimo_cyclist <- clean_fixed_effects(nanaimo_models_2$fixed_effects)

map(nanaimo_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

nanaimo_models_3 <- cma_models(nanaimo_sp@data,"Central Island-Powell River","n_pedestrian_casualty_claims","vandix_z") 

nanaimo_pedestrian <- clean_fixed_effects(nanaimo_models_3$fixed_effects)

map(nanaimo_models_3$models,~summary(.x))

nanaimo_results <- bind_rows(nanaimo_all %>% mutate(Region = "Central Island-Powell River",Outcome = "All Injury Claims"),
                         nanaimo_cyclist %>% mutate(Region = "Central Island-Powell River",Outcome = "Cyclist Injury Claims"),
                         nanaimo_pedestrian %>% mutate(Region = "Central Island-Powell River",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())
```

## Okanagan

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

okanagan_sf <- bc_da %>% 
  filter(region_name == "Okanagan") 

 region_descriptives %>% 
   filter(region == "Okanagan") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = okanagan_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = okanagan_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = okanagan_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

okanagan_sp <- as(okanagan_sf, "Spatial")
okanagan_sp$ui <- 1:nrow(okanagan_sp@data)

coords <- coordinates(okanagan_sp)
okanagan_nb <- poly2nb(okanagan_sp, queen = TRUE,snap = 1)

okanagan_nb

#assign nearest neighbour for no links

# okanagan_nb <- assign_nearest_neighbors(okanagan_nb,okanagan_sp)

plot(okanagan_sp, border = grey(0.5))
plot(okanagan_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(okanagan_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(okanagan_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(okanagan_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(okanagan_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("okanagan.adj", okanagan_nb)
g <- inla.read.graph(filename = "okanagan.adj")


# Model Set 1: Total Casualty Claim Crashes

okanagan_models_1 <- cma_models(okanagan_sp@data, "Okanagan", "n_casualty_claims", "vandix_z") 

okanagan_all <- clean_fixed_effects(okanagan_models_1$fixed_effects)

map(okanagan_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

okanagan_models_2 <- cma_models(okanagan_sp@data,"Okanagan","n_cyclist_casualty_claims","vandix_z") 

okanagan_cyclist <- clean_fixed_effects(okanagan_models_2$fixed_effects)

map(okanagan_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

okanagan_models_3 <- cma_models(okanagan_sp@data,"Okanagan","n_pedestrian_casualty_claims","vandix_z") 

okanagan_pedestrian <- clean_fixed_effects(okanagan_models_3$fixed_effects)

map(okanagan_models_3$models,~summary(.x))

okanagan_results <- bind_rows(okanagan_all %>% mutate(Region = "Okanagan",Outcome = "All Injury Claims"),
                         okanagan_cyclist %>% mutate(Region = "Okanagan",Outcome = "Cyclist Injury Claims"),
                         okanagan_pedestrian %>% mutate(Region = "Okanagan",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())
```



## Fraser Valley

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

fraser_valley_sf <- bc_da %>% 
  filter(region_name == "Fraser Valley") 

 region_descriptives %>% 
   filter(region == "Fraser Valley") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = fraser_valley_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = fraser_valley_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = fraser_valley_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

fraser_valley_sp <- as(fraser_valley_sf, "Spatial")
fraser_valley_sp$ui <- 1:nrow(fraser_valley_sp@data)

coords <- coordinates(fraser_valley_sp)
fraser_valley_nb <- poly2nb(fraser_valley_sp, queen = TRUE)

fraser_valley_nb

#assign nearest neighbour for no links

fraser_valley_nb <- assign_nearest_neighbors(fraser_valley_nb,fraser_valley_sp)

plot(fraser_valley_sp, border = grey(0.5))
plot(fraser_valley_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(fraser_valley_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(fraser_valley_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(fraser_valley_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(fraser_valley_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("fraser_valley.adj", fraser_valley_nb)
g <- inla.read.graph(filename = "fraser_valley.adj")


# Model Set 1: Total Casualty Claim Crashes

fraser_valley_models_1 <- cma_models(fraser_valley_sp@data, "Fraser Valley", "n_casualty_claims", "vandix_z") 

fraser_valley_all <- clean_fixed_effects(fraser_valley_models_1$fixed_effects)

map(fraser_valley_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

fraser_valley_models_2 <- cma_models(fraser_valley_sp@data,"Fraser Valley","n_cyclist_casualty_claims","vandix_z") 

fraser_valley_cyclist <- clean_fixed_effects(fraser_valley_models_2$fixed_effects)

map(fraser_valley_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

fraser_valley_models_3 <- cma_models(fraser_valley_sp@data,"Fraser Valley","n_pedestrian_casualty_claims","vandix_z") 

fraser_valley_pedestrian <- clean_fixed_effects(fraser_valley_models_3$fixed_effects)

map(fraser_valley_models_3$models,~summary(.x))

fraser_valley_results <- bind_rows(fraser_valley_all %>% mutate(Region = "Fraser Valley",Outcome = "All Injury Claims"),
                         fraser_valley_cyclist %>% mutate(Region = "Fraser Valley",Outcome = "Cyclist Injury Claims"),
                         fraser_valley_pedestrian %>% mutate(Region = "Fraser Valley",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())
```


## North Central

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

north_central_sf <- bc_da %>% 
  filter(region_name == "North Central") 

 region_descriptives %>% 
   filter(region == "North Central") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = north_central_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = north_central_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = north_central_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

north_central_sp <- as(north_central_sf, "Spatial")
north_central_sp$ui <- 1:nrow(north_central_sp@data)

coords <- coordinates(north_central_sp)
north_central_nb <- poly2nb(north_central_sp, queen = TRUE)

north_central_nb

#assign nearest neighbour for no links

north_central_nb <- assign_nearest_neighbors(north_central_nb,north_central_sp)

plot(north_central_sp, border = grey(0.5))
plot(north_central_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(north_central_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(north_central_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(north_central_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(north_central_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("north_central.adj", north_central_nb)
g <- inla.read.graph(filename = "north_central.adj")


# Model Set 1: Total Casualty Claim Crashes

north_central_models_1 <- cma_models(north_central_sp@data, "North Central", "n_casualty_claims", "vandix_z") 

north_central_all <- clean_fixed_effects(north_central_models_1$fixed_effects)

map(north_central_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

north_central_models_2 <- cma_models(north_central_sp@data,"North Central","n_cyclist_casualty_claims","vandix_z") 

north_central_cyclist <- clean_fixed_effects(north_central_models_2$fixed_effects)

map(north_central_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

north_central_models_3 <- cma_models(north_central_sp@data,"North Central","n_pedestrian_casualty_claims","vandix_z") 

north_central_pedestrian <- clean_fixed_effects(north_central_models_3$fixed_effects)

map(north_central_models_3$models,~summary(.x))

north_central_results <- bind_rows(north_central_all %>% mutate(Region = "North Central",Outcome = "All Injury Claims"),
                         north_central_cyclist %>% mutate(Region = "North Central",Outcome = "Cyclist Injury Claims"),
                         north_central_pedestrian %>% mutate(Region = "North Central",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())
```

## Kamloops-Salmon Arm

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

interior_sf <- bc_da %>% 
  filter(region_name == "Kamloops-Salmon Arm") 

 region_descriptives %>% 
   filter(region == "Kamloops-Salmon Arm") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = interior_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = interior_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = interior_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

interior_sp <- as(interior_sf, "Spatial")
interior_sp$ui <- 1:nrow(interior_sp@data)

coords <- coordinates(interior_sp)
interior_nb <- poly2nb(interior_sp, queen = TRUE)

interior_nb

#assign nearest neighbour for no links

interior_nb <- assign_nearest_neighbors(interior_nb,interior_sp)

plot(interior_sp, border = grey(0.5))
plot(interior_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(interior_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(interior_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(interior_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(interior_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("interior.adj", interior_nb)
g <- inla.read.graph(filename = "interior.adj")


# Model Set 1: Total Casualty Claim Crashes

interior_models_1 <- cma_models(interior_sp@data, "Kamloops-Salmon Arm", "n_casualty_claims", "vandix_z") 

interior_all <- clean_fixed_effects(interior_models_1$fixed_effects)

map(interior_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

interior_models_2 <- cma_models(interior_sp@data,"Kamloops-Salmon Arm","n_cyclist_casualty_claims","vandix_z") 

interior_cyclist <- clean_fixed_effects(interior_models_2$fixed_effects)

map(interior_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

interior_models_3 <- cma_models(interior_sp@data,"Kamloops-Salmon Arm","n_pedestrian_casualty_claims","vandix_z") 

interior_pedestrian <- clean_fixed_effects(interior_models_3$fixed_effects)

map(interior_models_3$models,~summary(.x))

interior_results <- bind_rows(interior_all %>% mutate(Region = "Kamloops-Salmon Arm",Outcome = "All Injury Claims"),
                         interior_cyclist %>% mutate(Region = "Kamloops-Salmon Arm",Outcome = "Cyclist Injury Claims"),
                         interior_pedestrian %>% mutate(Region = "Kamloops-Salmon Arm",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())
```


## Southeast

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

southeast_sf <- bc_da %>% 
  filter(region_name == "Southeast") 

 region_descriptives %>% 
   filter(region == "Southeast") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = southeast_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = southeast_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = southeast_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

southeast_sp <- as(southeast_sf, "Spatial")
southeast_sp$ui <- 1:nrow(southeast_sp@data)

coords <- coordinates(southeast_sp)
southeast_nb <- poly2nb(southeast_sp, queen = TRUE)

southeast_nb

#assign nearest neighbour for no links

southeast_nb <- assign_nearest_neighbors(southeast_nb,southeast_sp)

plot(southeast_sp, border = grey(0.5))
plot(southeast_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(southeast_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(southeast_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(southeast_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(southeast_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("southeast.adj", southeast_nb)
g <- inla.read.graph(filename = "southeast.adj")


# Model Set 1: Total Casualty Claim Crashes

southeast_models_1 <- cma_models(southeast_sp@data, "Southeast", "n_casualty_claims", "vandix_z") 

southeast_all <- clean_fixed_effects(southeast_models_1$fixed_effects)

map(southeast_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

southeast_models_2 <- cma_models(southeast_sp@data,"Southeast","n_cyclist_casualty_claims","vandix_z") 

southeast_cyclist <- clean_fixed_effects(southeast_models_2$fixed_effects)

map(southeast_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

southeast_models_3 <- cma_models(southeast_sp@data,"Southeast","n_pedestrian_casualty_claims","vandix_z") 

southeast_pedestrian <- clean_fixed_effects(southeast_models_3$fixed_effects)

map(southeast_models_3$models,~summary(.x))

southeast_results <- bind_rows(southeast_all %>% mutate(Region = "Southeast",Outcome = "All Injury Claims"),
                         southeast_cyclist %>% mutate(Region = "Southeast",Outcome = "Cyclist Injury Claims"),
                         southeast_pedestrian %>% mutate(Region = "Southeast",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())
```


## Northwest

### Descriptive Statistics

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

northwest_sf <- bc_da %>% 
  filter(region_name == "Northwest") 

 region_descriptives %>% 
   filter(region == "Northwest") %>% 
   flextable() %>% 
      merge_v(j = ~ region + n ) %>% 
   theme_booktabs() %>% 
   colformat_double(
  big.mark = ",", digits = 1, na_str = "N/A"
) 

```


### Maps

```{r,fig.height=30,fig.width=20}


claims <- ggplot() + 
  geom_sf(data = northwest_sf, aes(fill = n_casualty_claims,colour=n_casualty_claims)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Insurance Claims",
                     type = "aggregation", palette = "Earth", direction = -1) + 
  theme_void() + 
  ggtitle(
    "Vancouver"
  )


vandix <- ggplot() + 
  geom_sf(data = northwest_sf, aes(fill = vandix_z_c,colour=vandix_z_c)) +
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  scale_colour_carto_d(name = "VanDIX Score ",
                     type = "diverging", palette = "Earth", direction = -1) + 
  theme_void()


total_roads <- ggplot() + 
  geom_sf(data = northwest_sf, aes(fill = total_roads_km,colour=total_roads_km)) + 
  coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") + 
  scale_fill_carto_c(name = "Kilometres of Road",
                     type = "quantitative", palette = "Earth", direction = -1) + 
  scale_colour_carto_c(name = "Kilometres of Road",
                       type = "quantitative", palette = "Earth", direction = -1) + 
  theme_void()

cowplot::plot_grid(claims,vandix,total_roads,ncol=1)
```

### Setting up Spatial Weights Matrix

```{r, fig.height=10,fig.width=10}

#### Define Spatial Neighrbourhoods

northwest_sp <- as(northwest_sf, "Spatial")
northwest_sp$ui <- 1:nrow(northwest_sp@data)

coords <- coordinates(northwest_sp)
northwest_nb <- poly2nb(northwest_sp, queen = TRUE)

northwest_nb

#assign nearest neighbour for no links

northwest_nb <- assign_nearest_neighbors(northwest_nb,northwest_sp)

plot(northwest_sp, border = grey(0.5))
plot(northwest_nb,
     coords = coords,
     add = TRUE, pch = 16, lwd = 2)
```

### Spatial Dependency in each crash type

```{r}

listw <- nb2listw(northwest_nb,zero.policy = TRUE)
all_cc_mi <- moran.test(northwest_sf$n_casualty_claims, listw,zero.policy = TRUE)
all_cc_mi

cyc_cc_mi <- moran.test(northwest_sf$n_cyclist_casualty_claims, listw,zero.policy = TRUE)
cyc_cc_mi


pd_cc_mi <- moran.test(northwest_sf$n_pedestrian_casualty_claims, listw,zero.policy = TRUE)
pd_cc_mi
```


### BYM2 Models


```{r}

nb2INLA("northwest.adj", northwest_nb)
g <- inla.read.graph(filename = "northwest.adj")


# Model Set 1: Total Casualty Claim Crashes

northwest_models_1 <- cma_models(northwest_sp@data, "Northwest", "n_casualty_claims", "vandix_z") 

northwest_all <- clean_fixed_effects(northwest_models_1$fixed_effects)

map(northwest_models_1$models, ~ summary(.x))

# Model Set 2: Total Casualty Cyclist Claim Crashes

northwest_models_2 <- cma_models(northwest_sp@data,"Northwest","n_cyclist_casualty_claims","vandix_z") 

northwest_cyclist <- clean_fixed_effects(northwest_models_2$fixed_effects)

map(northwest_models_2$models,~summary(.x))


# Model Set 3: Total Casualty Cyclist Claim Crashes

northwest_models_3 <- cma_models(northwest_sp@data,"Northwest","n_pedestrian_casualty_claims","vandix_z") 

northwest_pedestrian <- clean_fixed_effects(northwest_models_3$fixed_effects)

map(northwest_models_3$models,~summary(.x))

northwest_results <- bind_rows(northwest_all %>% mutate(Region = "Northwest",Outcome = "All Injury Claims"),
                         northwest_cyclist %>% mutate(Region = "Northwest",Outcome = "Cyclist Injury Claims"),
                         northwest_pedestrian %>% mutate(Region = "Northwest",Outcome = "Pedestrian Injury Claims")
                         ) %>%
  filter(variable == "vandix_z") %>%
  select(Region,Outcome,everything())

beepr::beep(8)
```

# Results

## Study Area

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}



regions <- bc_da %>%
  st_drop_geometry() %>%
  group_by(region_name) %>% 
  summarise(n = n(),
            CMAs = paste0(unique(cma_name),collapse = ";" ),
            n_casualty_claims = sum(n_casualty_claims,na.rm=TRUE),
                        n_cyclist_casualty_claims = sum(n_cyclist_casualty_claims,na.rm=TRUE),
            n_pedestrian_casualty_claims = sum(n_pedestrian_casualty_claims,na.rm=TRUE),
            population = sum(population,na.rm=TRUE)) %>% 
  
  arrange(desc(population)) %>% 
  remove_missing() 

cma_centroids <- bc_da %>% 
  group_by(cma_name) %>% 
  summarise(shape_area = sum(shape_area)) %>% 
  st_cast() %>% 
  st_centroid() 


cma_boundary <- bc_da %>% 
  group_by(cma_name) %>% 
  summarise(shape_area = sum(shape_area)) %>% 
  st_cast()

bc_boundary <- cancensus::get_census("CA21",
                                  level = "PR",
                                  regions = list(PR=59),geo_format = "sf") %>% 
  st_transform(crs = st_crs(cma_boundary))

bc_da <- bc_da %>% 
 mutate(region_name = factor(region_name, levels = regions$region_name))


set.seed(10)
ggplot() +
  geom_sf(data = bc_boundary, fill = "grey95")  +
  geom_sf(data = bc_da, aes(fill = region_name, colour = region_name)) +
  geom_sf(data = cma_centroids) +
  ggrepel::geom_label_repel(
    data = cma_centroids,
    aes(
      x = st_coordinates(cma_centroids)[, "X"],
      y = st_coordinates(cma_centroids)[, "Y"],
      label = cma_name
    ),
    force = 40,
    max.overlaps = Inf,
    label.padding = unit(0.25, "lines"),
    # Increase padding for readability
    fill = scales::alpha("white", 0.8),
    # Slightly more opaque background
    size = 4
  ) +  # Increase label text size
  scale_fill_carto_d(name = "Region", palette = "Antique") +
  scale_colour_carto_d(name = "Region", palette = "Antique") +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom") +
  labs(title = "Regional Grouping of Census Metropolitan and Agglomeration Areas", subtitle = "Labelled Points Represent CMA/CA Centroids")




bc_da %>%
  st_drop_geometry() %>%
  summarise(
    `Number of DAs` = n(),
    `Total Injury Claims` = sum(n_casualty_claims),
    `Injury Claims Mean (SD)` = paste0(
      signif(mean(n_casualty_claims), 3), 
      " (", signif(sd(n_casualty_claims), 3), ")"
    ),
    
    `Total Cycling Injury Claims` = sum(n_cyclist_casualty_claims),
    `Cycling Injury Claims Mean (SD)` = paste0(
      signif(mean(n_cyclist_casualty_claims), 3), 
      " (", signif(sd(n_cyclist_casualty_claims), 3), ")"
    ),
    
    `Total Pedestrian Injury Claims` = sum(n_pedestrian_casualty_claims),
    `Pedestrian Injury Claims Mean (SD)` = paste0(
      signif(mean(n_pedestrian_casualty_claims), 3), 
      " (", signif(sd(n_pedestrian_casualty_claims), 3), ")"
    ),
    
    `Population` = sum(population, na.rm = TRUE),
    
    `VANDIX Mean (SD)` = paste0(
      signif(mean(vandix, na.rm = TRUE), 2), 
      " (", signif(sd(vandix, na.rm = TRUE), 2), ")"
    ),
    
    # New variables added below
    `Total Roads (km)` = sum(total_roads_km, na.rm = TRUE),
    
    `Highway/Arterial Roads Proportion Mean (SD)` = paste0(
      signif(mean(roads_prop_highway_arterial, na.rm = TRUE), 3),
      " (", signif(sd(roads_prop_highway_arterial, na.rm = TRUE), 3), ")"
    ),
    
    `No Highschool Prevalence Mean (SD)` = paste0(
      signif(mean(no_highschool_prevalance, na.rm = TRUE), 3),
      " (", signif(sd(no_highschool_prevalance, na.rm = TRUE), 3), ")"
    ),
    
    `Unemployment Rate Mean (SD)` = paste0(
      signif(mean(unemployment_rate, na.rm = TRUE), 3),
      " (", signif(sd(unemployment_rate, na.rm = TRUE), 3), ")"
    ),
    
    `Average Household Income Mean (SD)` = paste0(
      signif(mean(hh_avg_income, na.rm = TRUE), 3),
      " (", signif(sd(hh_avg_income, na.rm = TRUE), 3), ")"
    ),
    
    `Participation Rate Mean (SD)` = paste0(
      signif(mean(participation_rate, na.rm = TRUE), 3),
      " (", signif(sd(participation_rate, na.rm = TRUE), 3), ")"
    ),
    
    `University Degree Prevalence Mean (SD)` = paste0(
      signif(mean(university_degree_prevalance, na.rm = TRUE), 3),
      " (", signif(sd(university_degree_prevalance, na.rm = TRUE), 3), ")"
    ),
    
    `Lone Parent Family Prevalence Mean (SD)` = paste0(
      signif(mean(lone_parent_fam_prevalence, na.rm = TRUE), 3),
      " (", signif(sd(lone_parent_fam_prevalence, na.rm = TRUE), 3), ")"
    ),
    
    `Home Ownership Prevalence Mean (SD)` = paste0(
      signif(mean(home_owner_prevalence, na.rm = TRUE), 3),
      " (", signif(sd(home_owner_prevalence, na.rm = TRUE), 3), ")"
    ),
    
    `ALE Index Mean (SD)` = paste0(
      signif(mean(ale_index, na.rm = TRUE), 3),
      " (", signif(sd(ale_index, na.rm = TRUE), 3), ")"
    ),
    
    `CANBICS Index Mean (SD)` = paste0(
      signif(mean(canbics_index, na.rm = TRUE), 3),
      " (", signif(sd(canbics_index, na.rm = TRUE), 3), ")"
    )
    
  ) %>%
  arrange(desc(Population)) %>% 
  flextable() %>% 
  theme_booktabs()


```

The analysis included `r sum(regions$n)` dissemination areas across 20 different metropolitan regions with a total of `r sum(regions$n_casualty_claims)` motor-vehicle crashes resulting in at least one injury, and   `r sum(regions$n_cyclist_casualty_claims)` such crashes involved at least one cyclist, while `r sum(regions$n_pedestrian_casualty_claims)` involved at least one pedestrian.

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}

bc_da %>%
  st_drop_geometry() %>%
  group_by(region_name) %>%
  summarise(
    `Number of DAs` = n(),
    `Total Injury Claims` = sum(n_casualty_claims),
    `Injury Claims Mean (SD)` = paste0(
      signif(mean(n_casualty_claims), 3), 
      " (", signif(sd(n_casualty_claims), 3), ")"
    ),
    
    `Total Cycling Injury Claims` = sum(n_cyclist_casualty_claims),
    `Cycling Injury Claims Mean (SD)` = paste0(
      signif(mean(n_cyclist_casualty_claims), 3), 
      " (", signif(sd(n_cyclist_casualty_claims), 3), ")"
    ),
    
    `Total Pedestrian Injury Claims` = sum(n_pedestrian_casualty_claims),
    `Pedestrian Injury Claims Mean (SD)` = paste0(
      signif(mean(n_pedestrian_casualty_claims), 3), 
      " (", signif(sd(n_pedestrian_casualty_claims), 3), ")"
    ),
    
    `Population` = sum(population, na.rm = TRUE),
    
    `VANDIX Mean (SD)` = paste0(
      signif(mean(vandix, na.rm = TRUE), 2), 
      " (", signif(sd(vandix, na.rm = TRUE), 2), ")"
    ),
    
    # New variables added below
    `Total Roads (km)` = sum(total_roads_km, na.rm = TRUE),
    
    `Highway/Arterial Roads Proportion Mean (SD)` = paste0(
      signif(mean(roads_prop_highway_arterial, na.rm = TRUE), 3),
      " (", signif(sd(roads_prop_highway_arterial, na.rm = TRUE), 3), ")"
    ),
    
    `No Highschool Prevalence Mean (SD)` = paste0(
      signif(mean(no_highschool_prevalance, na.rm = TRUE), 3),
      " (", signif(sd(no_highschool_prevalance, na.rm = TRUE), 3), ")"
    ),
    
    `Unemployment Rate Mean (SD)` = paste0(
      signif(mean(unemployment_rate, na.rm = TRUE), 3),
      " (", signif(sd(unemployment_rate, na.rm = TRUE), 3), ")"
    ),
    
    `Average Household Income Mean (SD)` = paste0(
      signif(mean(hh_avg_income, na.rm = TRUE), 3),
      " (", signif(sd(hh_avg_income, na.rm = TRUE), 3), ")"
    ),
    
    `Participation Rate Mean (SD)` = paste0(
      signif(mean(participation_rate, na.rm = TRUE), 3),
      " (", signif(sd(participation_rate, na.rm = TRUE), 3), ")"
    ),
    
    `University Degree Prevalence Mean (SD)` = paste0(
      signif(mean(university_degree_prevalance, na.rm = TRUE), 3),
      " (", signif(sd(university_degree_prevalance, na.rm = TRUE), 3), ")"
    ),
    
    `Lone Parent Family Prevalence Mean (SD)` = paste0(
      signif(mean(lone_parent_fam_prevalence, na.rm = TRUE), 3),
      " (", signif(sd(lone_parent_fam_prevalence, na.rm = TRUE), 3), ")"
    ),
    
    `Home Ownership Prevalence Mean (SD)` = paste0(
      signif(mean(home_owner_prevalence, na.rm = TRUE), 3),
      " (", signif(sd(home_owner_prevalence, na.rm = TRUE), 3), ")"
    ),
    
    `ALE Index Mean (SD)` = paste0(
      signif(mean(ale_index, na.rm = TRUE), 3),
      " (", signif(sd(ale_index, na.rm = TRUE), 3), ")"
    ),
    
    `CANBICS Index Mean (SD)` = paste0(
      signif(mean(canbics_index, na.rm = TRUE), 3),
      " (", signif(sd(canbics_index, na.rm = TRUE), 3), ")"
    )
    
  ) %>%
  arrange(desc(Population)) %>% 
  flextable() %>% 
  theme_booktabs()

```



## Association between Deprivation Index and Traffic Injury

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}
all <- bind_rows(
  van_results,
  victoria_results,
  nanaimo_results,
  okanagan_results,
  fraser_valley_results,
  north_central_results,
  interior_results,
  southeast_results,
  northwest_results
)

all <- all %>%
  mutate(Variable = "VanDIX (SD)") %>%
  select(Variable,Region,Outcome, 4,6) %>%
  split(.$Outcome)
```


### Crude Rates

#### All Motor Vehicle Traffic Injury Crashes

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}

# crude_rates <- bc_da %>% 
#   st_drop_geometry() %>% 
#   filter(cma_name %in% cmas$cma_name) %>% 
#   group_by(cma_name,vandix_quintile) %>% 
#   summarise(n_das = n(), 
#             n_casualty_claims = sum(n_casualty_claims, na.rm=TRUE),
#             n_cyclist_casualty_claims = sum(n_cyclist_casualty_claims,na.rm = TRUE),
#             n_pedestrian_casualty_claims = sum(n_pedestrian_casualty_claims),
#             total_roads_km = sum(total_roads_km,na.rm = TRUE),
#             casualty_claims_rate = n_casualty_claims/total_roads_km*100,
#             cyclist_casualty_claims_rate = n_cyclist_casualty_claims/total_roads_km*100,
#             pedestrian_casualty_claims_rate = n_pedestrian_casualty_claims/total_roads_km*100) %>% 
#   mutate(cma_name = factor(cma_name, levels = cmas$cma_name))
# 
# crude_rates %>% 
#   remove_missing() %>% 
#   ggplot(aes(x = vandix_quintile,y =casualty_claims_rate,group = 1)) + 
#   geom_point() + 
#   stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +  # Customize line color and style
#   facet_wrap(~cma_name) +
#   labs(
#     title = "Motor vehicle Traffic Injury Crashes per 100 km of road by Vandix Quintile",
#     x = "VanDIX Quintile",
#     y = "Rate per 100 km road",
#   ) +
#   theme_minimal() +  # Use a minimal theme
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Center and style title
#     axis.title = element_text(size = 14),
#     axis.text = element_text(size = 12),
#     axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
#     strip.text = element_text(size = 12, face = "bold")  # Style facet labels
#   )



equation_data <- bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  group_by(region_name) %>%
  summarize(
    model = list(lm(n_casualty_claims_rate ~ vandix_z, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(tidy_model = map(model, tidy)) %>%
  unnest(tidy_model) %>%
  filter(term %in% c("(Intercept)", "vandix_z")) %>%
  summarize(
    intercept = estimate[term == "(Intercept)"],
    slope = estimate[term == "vandix_z"],
    p_value = p.value[term == "vandix_z"],
    equation = paste("y =", signif(intercept, 3), "+", signif(slope, 3), "* x"),
    significance = ifelse(p_value < 0.05, " (p < 0.05)", " (ns)"),
    full_equation = paste(equation, significance),
    .by = c("region_name")
  ) %>% 
  mutate(region_name = factor(region_name, levels = regions$region_name)) %>% 
  arrange(region_name)



# Create the plot
bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
    mutate(region_name = factor(region_name, levels = regions$region_name)) %>% 
  ggplot(aes(x = vandix_z, y = casualty_claims_rate)) +
  geom_point(alpha = 0.1) +
    stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +
  # stat_smooth(method = "loess", se = TRUE, color = "red", linetype = "dashed", linewidth = 1,span = 0.8) +
  facet_wrap(~region_name) +
  labs(
    title = "Crash Rates per 10km of Road by VanDIX score",
    x = "Neighbourhood Deprivation",
    y = "Injury Crashes per 10km of Road"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold")
  ) +
  # Add the regression equation to each facet
  geom_text(data = equation_data,
            aes(x = Inf, y = Inf, label = full_equation), 
            hjust = 1.1, vjust = 1.5,
            size = 4)



```


#### Bicycle-Motor Vehicle Traffic Injury Crashes

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}
# 
# crude_rates %>% 
#   remove_missing() %>% 
#   ggplot(aes(x = vandix_quintile,y =cyclist_casualty_claims_rate,group = 1)) + 
#   geom_point() + 
#   stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +  # Customize line color and style
#   facet_wrap(~cma_name) +
#   labs(
#     title = "Bicycle-Motor Vehicle Traffic Injury Crashes per 100 km of road by Vandix Quintile",
#     x = "VanDIX Quintile",
#     y = "Rate per 100 km road",
#   ) +
#   theme_minimal() +  # Use a minimal theme
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Center and style title
#     axis.title = element_text(size = 14),
#     axis.text = element_text(size = 12),
#     axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
#     strip.text = element_text(size = 12, face = "bold")  # Style facet labels
#   )



equation_data <- bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  group_by(region_name) %>%
  summarize(
    model = list(lm(cyclist_casualty_claims_rate ~ vandix_z, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(tidy_model = map(model, tidy)) %>%
  unnest(tidy_model) %>%
  filter(term %in% c("(Intercept)", "vandix_z")) %>%
  summarize(
    intercept = estimate[term == "(Intercept)"],
    slope = estimate[term == "vandix_z"],
    p_value = p.value[term == "vandix_z"],
    equation = paste("y =", signif(intercept, 3), "+", signif(slope, 3), "* x"),
    significance = ifelse(p_value < 0.05, " (p < 0.05)", " (ns)"),
    full_equation = paste(equation, significance),
    .by = c("region_name")
  ) %>% 
  mutate(region_name = factor(region_name, levels = regions$region_name)) %>% 
  arrange(region_name)



# Create the plot
bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 

  ggplot(aes(x = vandix_z, y = cyclist_casualty_claims_rate)) +
  geom_point(alpha = 0.2) +
  stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~region_name) +
  labs(
    title = "Cyclist-Motor vehicle Crash Rates per 10km of Road by VanDIX score",
    x = "Neighbourhood Deprivation",
    y = "Injury Crashes per 10km of Road"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold")
  ) +
  # Add the regression equation to each facet
  geom_text(data = equation_data,
            aes(x = Inf, y = Inf, label = full_equation), 
            hjust = 1.1, vjust = 1.5,
            size = 4)

```


#### Pedestrian-Motor Vehicle Traffic Injury Crashes

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}

# crude_rates %>% 
#   remove_missing() %>% 
#   ggplot(aes(x = vandix_quintile,y =pedestrian_casualty_claims_rate,group = 1)) + 
#   geom_point() + 
#   stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +  # Customize line color and style
#   facet_wrap(~cma_name) +
#   labs(
#     title = "Pedestrian-Motor Vehicle Traffic Injury Crashes per 100 km of road by Vandix Quintile",
#     x = "VanDIX Quintile",
#     y = "Rate per 100 km road",
#   ) +
#   theme_minimal() +  # Use a minimal theme
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Center and style title
#     axis.title = element_text(size = 14),
#     axis.text = element_text(size = 12),
#     axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
#     strip.text = element_text(size = 12, face = "bold")  # Style facet labels
#     
#     
  # )


equation_data <- bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  group_by(region_name) %>%
  summarize(
    model = list(lm(pedestrian_casualty_claims_rate ~ vandix_z, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(tidy_model = map(model, tidy)) %>%
  unnest(tidy_model) %>%
  filter(term %in% c("(Intercept)", "vandix_z")) %>%
  summarize(
    intercept = estimate[term == "(Intercept)"],
    slope = estimate[term == "vandix_z"],
    p_value = p.value[term == "vandix_z"],
    equation = paste("y =", signif(intercept, 3), "+", signif(slope, 3), "* x"),
    significance = ifelse(p_value < 0.05, " (p < 0.05)", " (ns)"),
    full_equation = paste(equation, significance),
    .by = c("region_name")
  ) %>% 
  mutate(region_name = factor(region_name, levels = regions$region_name)) %>% 
  arrange(region_name)



# Create the plot
bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  ggplot(aes(x = vandix_z, y =pedestrian_casualty_claims_rate)) +
  geom_point(alpha = 0.2) +
  stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~region_name) +
  labs(
    title = "Cyclist-Motor vehicle Crash Rates per 10km of Road by VanDIX score",
    x = "Neighbourhood Deprivation",
    y = "Injury Crashes per 10km of Road"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold")
  ) +
  # Add the regression equation to each facet
  geom_text(data = equation_data,
            aes(x = Inf, y = Inf, label = full_equation), 
            hjust = 1.1, vjust = 1.5,
            size = 4)
```


### Spatial Models

#### All Motor Vehicle Traffic Injury Crashes

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}

all$`All Injury Claims` %>%
  select(-Outcome) %>%
  flextable() %>%
  merge_v(j = ~Variable) %>%
  footnote(i = 1, j = 4,
           value = as_paragraph(
             c("Adjusted for (i) total length of roads; (ii) proportion of roads classified as highway or arterial; (iii) the Canadian Active Living Environment Index; (iv) the Canadian Bikeway Comfort and Safety Index; (v) Total population")
           ),
           ref_symbols = c("a"),
           part = "header")%>%
  set_table_properties( layout = "autofit") %>%
  valign( valign = "bottom", part = "header") %>%
  set_caption("Relationship between VanDIX score and total number of motor-vehicle crash insurance claims from 2019-2023.") %>%
  theme_booktabs()


all$`All Injury Claims`  %>% 
  mutate(Fully_Adjusted_IRR = gsub(" ", "", `Fully Adjusted IRR (95% CI)`), # Remove spaces
         estimate = as.numeric(gsub("\\(.*", "", `Fully Adjusted IRR (95% CI)`)),
         lower_ci = as.numeric(gsub(".*\\(([^,]*),.*", "\\1", `Fully Adjusted IRR (95% CI)`)),
         upper_ci = as.numeric(gsub(".*,(.*)\\)", "\\1", `Fully Adjusted IRR (95% CI)`))) %>% 
ggplot(aes(x = fct_reorder(Region, estimate), y = estimate)) +
  geom_point(size = 4) +  # Increased point size and added color for differentiation
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.3, alpha = 0.6) +  # Lighter color for CI and thicker error bars
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", linewidth = 1) +  # Stronger line at IRR = 1
  coord_flip() +  # Keep flipped coordinates for readability
  scale_y_log10(breaks = c(0.1, 0.5, 1, 2, 10), labels = c(0.1, 0.5, 1, 2, 10)) +  # Log10 scale
  labs(
    title = "Neighborhood Deprivation and Road Traffic Injury Crashes by Region",
    subtitle = "Each standard deviation increase in VanDIX increases road traffic injury crashes",
    x = "Census Metropolitan/Agglomeration Area",
    y = "Incidence Rate Ratio (Deprivation Index in Standard Deviations)"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 9),  # Increase y-axis text size for legibility
    axis.title.x = element_text(size = 11),  # Make axis titles more prominent
    plot.title = element_text(size = 12, face = "bold"),  # Bolder and larger title
    plot.subtitle = element_text(size = 10),  # Adjust subtitle size
    legend.position = "none"  # Remove legend as it's not needed for simple color encoding
  )
```

#### Bicycle-Motor Vehicle Traffic Injury Crashes


```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}
all$`Cyclist Injury Claims` %>%
  select(-Outcome) %>%
  flextable() %>%
  merge_v(j = ~Variable) %>%
  footnote(i = 1, j = 4,
           value = as_paragraph(
             c("Adjusted for (i) total length of roads; (ii) proportion of roads classified as highway or arterial; (iii) the Canadian Active Living Environment Index; (iv) the Canadian Bikeway Comfort and Safety Index; (v) Total population")
           ),
           ref_symbols = c("a"),
           part = "header")%>%
  set_table_properties( layout = "autofit") %>%
  valign( valign = "bottom", part = "header") %>%
  set_caption("Relationship between VanDIX score and total number of motor-vehicle - cyclist crash insurance claims from 2019-2023.") %>%
  theme_booktabs()

all$`Cyclist Injury Claims`  %>% 
  mutate(Fully_Adjusted_IRR = gsub(" ", "", `Fully Adjusted IRR (95% CI)`), # Remove spaces
         estimate = as.numeric(gsub("\\(.*", "", `Fully Adjusted IRR (95% CI)`)),
         lower_ci = as.numeric(gsub(".*\\(([^,]*),.*", "\\1", `Fully Adjusted IRR (95% CI)`)),
         upper_ci = as.numeric(gsub(".*,(.*)\\)", "\\1", `Fully Adjusted IRR (95% CI)`))) %>% 
ggplot(aes(x = fct_reorder(Region, estimate), y = estimate)) +
  geom_point(size = 4) +  # Increased point size and added color for differentiation
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.3, alpha = 0.6) +  # Lighter color for CI and thicker error bars
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", linewidth = 1) +  # Stronger line at IRR = 1
  coord_flip() +  # Keep flipped coordinates for readability
  scale_y_log10(breaks = c(0.1, 0.5, 1, 2, 10), labels = c(0.1, 0.5, 1, 2, 10)) +  # Log10 scale
  labs(
    title = "Neighborhood Deprivation and Cyclist-Motor Vehicle Traffic Injury Crashes by Region",
    subtitle = "Each standard deviation increase in VanDIX increases road traffic injury crashes",
    x = "Census Metropolitan/Agglomeration Area",
    y = "Incidence Rate Ratio (Deprivation Index in Standard Deviations)"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 9),  # Increase y-axis text size for legibility
    axis.title.x = element_text(size = 11),  # Make axis titles more prominent
    plot.title = element_text(size = 12, face = "bold"),  # Bolder and larger title
    plot.subtitle = element_text(size = 10),  # Adjust subtitle size
    legend.position = "none"  # Remove legend as it's not needed for simple color encoding
  )
```

#### Pedestrian-Motor Vehicle Traffic Injury Crashes

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}
all$`Pedestrian Injury Claims` %>%
  select(-Outcome) %>%
  flextable() %>%
  merge_v(j = ~Variable) %>%
  footnote(i = 1, j = 4,
           value = as_paragraph(
             c("Adjusted for (i) total length of roads; (ii) proportion of roads classified as highway or arterial; (iii) the Canadian Active Living Environment Index; (iv) the Canadian Bikeway Comfort and Safety Index; (v) Total population")
           ),
           ref_symbols = c("a"),
           part = "header")%>%
  set_table_properties( layout = "autofit") %>%
  valign( valign = "bottom", part = "header") %>%
  set_caption("Table 3: Relationship between VanDIX score and total number of motor-vehicle - pedestrian crash insurance claims from 2019-2023.") %>%
  theme_booktabs()

all$`Pedestrian Injury Claims`  %>% 
  mutate(Fully_Adjusted_IRR = gsub(" ", "", `Fully Adjusted IRR (95% CI)`), # Remove spaces
         estimate = as.numeric(gsub("\\(.*", "", `Fully Adjusted IRR (95% CI)`)),
         lower_ci = as.numeric(gsub(".*\\(([^,]*),.*", "\\1", `Fully Adjusted IRR (95% CI)`)),
         upper_ci = as.numeric(gsub(".*,(.*)\\)", "\\1", `Fully Adjusted IRR (95% CI)`))) %>% 
ggplot(aes(x = fct_reorder(Region, estimate), y = estimate)) +
  geom_point(size = 4) +  # Increased point size and added color for differentiation
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.3, alpha = 0.6) +  # Lighter color for CI and thicker error bars
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", linewidth = 1) +  # Stronger line at IRR = 1
  coord_flip() +  # Keep flipped coordinates for readability
  scale_y_log10(breaks = c(0.1, 0.5, 1, 2, 10), labels = c(0.1, 0.5, 1, 2, 10)) +  # Log10 scale
  labs(
    title = "Neighborhood Deprivation and Pedestrian-Motor Vehicle Traffic Injury Crashes by Region",
    subtitle = "Each standard deviation increase in VanDIX increases road traffic injury crashes",
    x = "Census Metropolitan/Agglomeration Area",
    y = "Incidence Rate Ratio (Deprivation Index in Standard Deviations)"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 9),  # Increase y-axis text size for legibility
    axis.title.x = element_text(size = 11),  # Make axis titles more prominent
    plot.title = element_text(size = 12, face = "bold"),  # Bolder and larger title
    plot.subtitle = element_text(size = 10),  # Adjust subtitle size
    legend.position = "none"  # Remove legend as it's not needed for simple color encoding
  )

```


# Supplementary Material

## Built Environment by VanDIX


```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}

be_by_cma_vandix <- bc_da %>%
  st_drop_geometry() %>%
  group_by(region_name, vandix_quintile) %>%
  summarise(
    `Number of DAs` = n(),
    `Population` = sum(population, na.rm = TRUE),
    
    # Rounding total roads to the nearest km
    `Total Roads (km)` = round(sum(total_roads_km, na.rm = TRUE), 0),
    `Total Roads Mean (SD)` = paste0(
      signif(mean(total_roads_km, na.rm = TRUE), 3),
      " (", signif(sd(total_roads_km, na.rm = TRUE), 3), ")"
    ),
    
       # Rounding total roads to the nearest km
    `% of Roads that are Arterial|Highway Mean (SD)` = paste0(
      signif(mean(roads_prop_highway_arterial*100, na.rm = TRUE), 3),
      " (", signif(sd(roads_prop_highway_arterial*100, na.rm = TRUE), 3), ")"
    ),
    
    `ALE Index Mean (SD)` = paste0(
      signif(mean(ale_index, na.rm = TRUE), 3),
      " (", signif(sd(ale_index, na.rm = TRUE), 3), ")"
    ),
    
    `CANBICS Index Mean (SD)` = paste0(
      signif(mean(canbics_index, na.rm = TRUE), 3),
      " (", signif(sd(canbics_index, na.rm = TRUE), 3), ")"
    )
    
  ) 


# Prepare data and calculate regression equations

equation_data <- bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
   mutate(region_name = factor(region_name, levels = regions$region_name)) %>% 
  group_by(region_name) %>%
  summarize(
    model = list(lm(roads_prop_highway_arterial*100 ~ vandix_z, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(tidy_model = map(model, tidy)) %>%
  unnest(tidy_model) %>%
  filter(term %in% c("(Intercept)", "vandix_z")) %>%
  summarize(
    intercept = estimate[term == "(Intercept)"],
    slope = estimate[term == "vandix_z"],
    p_value = p.value[term == "vandix_z"],
    equation = paste("y =", signif(intercept, 3), "+", signif(slope, 3), "* x"),
    significance = ifelse(p_value < 0.05, " (p < 0.05)", " (ns)"),
    full_equation = paste(equation, significance),
    .by = c("region_name")
  ) %>% 
  arrange(region_name)



# Create the plot
bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  ggplot(aes(x = vandix_z, y = roads_prop_highway_arterial*100)) +
    geom_point(alpha = 0.1) +
  stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~region_name,nrow = 3) +
  labs(
    title = "Proportion of Roads that are Arterial or Highway by VanDIX score",
    x = "Neighbourhood Deprivation",
    y = "% of roads that are arterial or highway"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 12, face = "bold")
  ) +
  # Add the regression equation to each facet
  geom_text(data = equation_data,
            aes(x = Inf, y = Inf, label = full_equation), 
            hjust = 1.1, vjust = 1.5,
            size = 4)
```


- Of the 9 regions, we observed `r equation_data %>% filter(slope>0) %>% nrow()` had on average a positive relationship with deprivation index and the proportion of roads in the neighborhood that were arterial or highway


```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}

equation_data <- bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  group_by(region_name) %>%
  summarize(
    model = list(lm(ale_index_z ~ vandix_z, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(tidy_model = map(model, tidy)) %>%
  unnest(tidy_model) %>%
  filter(term %in% c("(Intercept)", "vandix_z")) %>%
  summarize(
    intercept = estimate[term == "(Intercept)"],
    slope = estimate[term == "vandix_z"],
    p_value = p.value[term == "vandix_z"],
    equation = paste("y =", signif(intercept, 3), "+", signif(slope, 3), "* x"),
    significance = ifelse(p_value < 0.05, " (p < 0.05)", " (ns)"),
    full_equation = paste(equation, significance),
    .by = c("region_name")
  ) %>% 
  mutate(region_name = factor(region_name, levels = regions$region_name)) %>% 
  arrange(region_name)



# Create the plot
bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  ggplot(aes(x = vandix_z, y = ale_index_z)) +
    geom_point(alpha = 0.1) +
  stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~region_name) +
  labs(
    title = "Active Living Environment Index by VanDIX score",
    x = "Neighbourhood Deprivation",
    y = "ALE Index (SD) "
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 12, face = "bold")
  ) +
  # Add the regression equation to each facet
  geom_text(data = equation_data,
            aes(x = Inf, y = Inf, label = full_equation), 
            hjust = 1.1, vjust = 1.5,
            size = 4)

```


- Of the 9 regions, we observed `r equation_data %>% filter(slope>0) %>% nrow()` had on average a positive relationship with deprivation index and thactive living environment index score

```{r, echo = FALSE, fig.width= 7.5, fig.height=10,warning=FALSE,message=FALSE}

equation_data <- bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 
  group_by(region_name) %>%
  summarize(
    model = list(lm(canbics_index_z ~ vandix_z, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(tidy_model = map(model, tidy)) %>%
  unnest(tidy_model) %>%
  filter(term %in% c("(Intercept)", "vandix_z")) %>%
  summarize(
    intercept = estimate[term == "(Intercept)"],
    slope = estimate[term == "vandix_z"],
    p_value = p.value[term == "vandix_z"],
    equation = paste("y =", signif(intercept, 3), "+", signif(slope, 3), "* x"),
    significance = ifelse(p_value < 0.05, " (p < 0.05)", " (ns)"),
    full_equation = paste(equation, significance),
    .by = c("region_name")
  ) %>% 
  mutate(region_name = factor(region_name, levels = regions$region_name)) %>% 
  arrange(region_name)



# Create the plot
bc_da %>%
  st_drop_geometry() %>%
  filter(!is.na(region_name)) %>% 

  ggplot(aes(x = vandix_z, y = canbics_index_z)) +
    geom_point(alpha = 0.1) +
  stat_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~region_name) +
  labs(
    title = "Canadian Bikeway Comfort Index by VanDIX score",
    x = "Neighbourhood Deprivation",
    y = "CanBICS Index (SD) "
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 12, face = "bold")
  ) +
  # Add the regression equation to each facet
  geom_text(data = equation_data,
            aes(x = Inf, y = Inf, label = full_equation), 
            hjust = 1.1, vjust = 1.5,
            size = 4)

```

- Of the 9 regions, we observed `r equation_data %>% filter(slope>0) %>% nrow()` had on average a positive relationship with deprivation index and increased access to better bicycle facilities. 


## Model Details

### Vancouver Model Details

#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

summarise_models_details <- function(inla_model_list){

results <- lapply(inla_model_list, function(x) tidy_inla(x$summary.fixed,exponentiate = FALSE,sigfig = 3) %>% mutate(term = row.names(.)))

prs <- function(x,n.dig = 3){

  formatC(signif(x,n.dig), format='f', big.mark = ",",digits = n.dig)
}

results_hyper_parameters <- lapply(inla_model_list, function(x) x$summary.hyper %>% rownames_to_column(var = "term"))
# Identifying unique names of the tibbles in the list

results_hyper_parameters_combined <- reduce(results_hyper_parameters, full_join, by = "term") %>% 
        mutate(
      `Unadjusted` = ifelse(is.na(mean.x), "", paste0(
        prs(mean.x),
        " (",
        prs(`0.025quant.x`),
        ", ",
        prs(`0.975quant.x`),
        ")"
      )),
      `Adjusted1` = paste0(
        prs(mean.y),
        " (",
        prs(`0.025quant.y`),
        ", ",
        prs(`0.975quant.y`),
        ")"
      ),
            `Adjusted2` = paste0(
        prs(mean),
        " (",
        prs(`0.025quant`),
        ", ",
        prs(`0.975quant`),
        ")"
      ),
    ) %>%
    select(term,`Unadjusted`,`Adjusted1`,`Adjusted2`)
# Applying function to each unique name
results_combined <- reduce(results, full_join, by = "term") %>% 
    mutate(
      `Unadjusted` = ifelse(is.na(estimate.x), "", paste0(
        prs(estimate.x),
        " (",
        prs(lower_ci.x),
        ", ",
        prs(upper_ci.x),
        ")"
      )),
      `Adjusted1` = paste0(
        prs(estimate.y),
        " (",
        prs(lower_ci.y),
        ", ",
        prs(upper_ci.y),
        ")"
      ),
            `Adjusted2` = paste0(
        prs(estimate),
        " (",
        prs(lower_ci),
        ", ",
        prs(upper_ci),
        ")"
      ),
    ) %>%
    select(term,`Unadjusted`,`Adjusted1`,`Adjusted2`)


results_hyper_parameters_combined <- results_hyper_parameters_combined %>%
  add_row(term = "Hyper Parameters",.before = -Inf)

results_combined <- results_combined %>%
  add_row(.,term = "Fixed Effects",.before = -Inf)



result_tibbles <- bind_rows(results_combined,results_hyper_parameters_combined) %>% 
    mutate( Unadjusted = str_remove_all(Unadjusted,"NA \\(|NA\\,|NA\\)"),
           Adjusted1 = str_remove_all(Adjusted1,"NA \\(|NA\\,|NA\\)"),
           Adjusted2 = str_remove_all(Adjusted2,"NA \\(|NA\\,|NA\\)")
    )

return(result_tibbles)
}

 summarise_models_details(van_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))
 
 
 
 #009392,#72aaa1,#b1c7b3,#f1eac8,#e5b9ad,#d98994,#d0587e
 
vancouver_sf$re_all_adjusted <- van_models_1$models$Adjusted2$summary.random$ui[1:nrow(vancouver_sf), "mean"]


ggplot(vancouver_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
 
```

#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(van_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


vancouver_sf$re_cyclists_adjusted <- van_models_2$models$Adjusted2$summary.random$ui[1:nrow(vancouver_sf), "mean"]


ggplot(vancouver_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```

#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(van_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))

vancouver_sf$re_pedestrians_adjusted <- van_models_3$models$Adjusted2$summary.random$ui[1:nrow(vancouver_sf), "mean"]
ggplot(vancouver_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```

### Victoria Model Details

#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(victoria_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


victoria_sf$re_all_adjusted <- victoria_models_1$models$Adjusted2$summary.random$ui[1:nrow(victoria_sf), "mean"]

ggplot(victoria_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```

#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(victoria_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))




victoria_sf$re_cyclists_adjusted <- victoria_models_2$models$Adjusted2$summary.random$ui[1:nrow(victoria_sf), "mean"]
ggplot(victoria_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(victoria_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



victoria_sf$re_pedestrians_adjusted <- victoria_models_3$models$Adjusted2$summary.random$ui[1:nrow(victoria_sf), "mean"]
ggplot(victoria_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

### Central Island - Powell River Model Details

#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(nanaimo_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


nanaimo_sf$re_all_adjusted <- nanaimo_models_1$models$Adjusted2$summary.random$ui[1:nrow(nanaimo_sf), "mean"]

ggplot(nanaimo_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```

#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(nanaimo_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


nanaimo_sf$re_cyclists_adjusted <- nanaimo_models_2$models$Adjusted2$summary.random$ui[1:nrow(nanaimo_sf), "mean"]
ggplot(nanaimo_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(nanaimo_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



nanaimo_sf$re_pedestrians_adjusted <- nanaimo_models_3$models$Adjusted2$summary.random$ui[1:nrow(nanaimo_sf), "mean"]
ggplot(nanaimo_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

### Okanagan Model Details

#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(okanagan_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


okanagan_sf$re_all_adjusted <- okanagan_models_1$models$Adjusted2$summary.random$ui[1:nrow(okanagan_sf), "mean"]

ggplot(okanagan_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```


#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(okanagan_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


okanagan_sf$re_cyclists_adjusted <- okanagan_models_2$models$Adjusted2$summary.random$ui[1:nrow(okanagan_sf), "mean"]
ggplot(okanagan_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```


#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(okanagan_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



okanagan_sf$re_pedestrians_adjusted <- okanagan_models_3$models$Adjusted2$summary.random$ui[1:nrow(okanagan_sf), "mean"]
ggplot(okanagan_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```


### Fraser Valley Model Details

#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(fraser_valley_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


fraser_valley_sf$re_all_adjusted <- fraser_valley_models_1$models$Adjusted2$summary.random$ui[1:nrow(fraser_valley_sf), "mean"]

ggplot(fraser_valley_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```

#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(fraser_valley_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


fraser_valley_sf$re_cyclists_adjusted <- fraser_valley_models_2$models$Adjusted2$summary.random$ui[1:nrow(fraser_valley_sf), "mean"]
ggplot(fraser_valley_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(fraser_valley_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



fraser_valley_sf$re_pedestrians_adjusted <- fraser_valley_models_3$models$Adjusted2$summary.random$ui[1:nrow(fraser_valley_sf), "mean"]
ggplot(fraser_valley_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

### North Central Model Details


#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(north_central_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


north_central_sf$re_all_adjusted <- north_central_models_1$models$Adjusted2$summary.random$ui[1:nrow(north_central_sf), "mean"]

ggplot(north_central_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```


#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

summarise_models_details(north_central_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


north_central_sf$re_cyclists_adjusted <- north_central_models_2$models$Adjusted2$summary.random$ui[1:nrow(north_central_sf), "mean"]
ggplot(north_central_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```


#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(north_central_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



north_central_sf$re_pedestrians_adjusted <- north_central_models_3$models$Adjusted2$summary.random$ui[1:nrow(north_central_sf), "mean"]
ggplot(north_central_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```


### Kamloops-Salmon Arm


#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(interior_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


interior_sf$re_all_adjusted <- interior_models_1$models$Adjusted2$summary.random$ui[1:nrow(interior_sf), "mean"]

ggplot(interior_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```


#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(interior_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


interior_sf$re_cyclists_adjusted <- interior_models_2$models$Adjusted2$summary.random$ui[1:nrow(interior_sf), "mean"]
ggplot(interior_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```


#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(interior_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



interior_sf$re_pedestrians_adjusted <- interior_models_3$models$Adjusted2$summary.random$ui[1:nrow(interior_sf), "mean"]
ggplot(interior_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

### Southeast


#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(southeast_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


southeast_sf$re_all_adjusted <- southeast_models_1$models$Adjusted2$summary.random$ui[1:nrow(southeast_sf), "mean"]

ggplot(southeast_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```


#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(southeast_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


southeast_sf$re_cyclists_adjusted <- southeast_models_2$models$Adjusted2$summary.random$ui[1:nrow(southeast_sf), "mean"]
ggplot(southeast_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```


#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(southeast_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



southeast_sf$re_pedestrians_adjusted <- southeast_models_3$models$Adjusted2$summary.random$ui[1:nrow(southeast_sf), "mean"]
ggplot(southeast_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

### Northwest


#### All
```{r, echo = FALSE, fig.width= 7.5, fig.height=10}

 summarise_models_details(northwest_models_1$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


northwest_sf$re_all_adjusted <- northwest_models_1$models$Adjusted2$summary.random$ui[1:nrow(northwest_sf), "mean"]

ggplot(northwest_sf) + geom_sf(aes(fill = re_all_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for All Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
 
```


#### Cyclists

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(northwest_models_2$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))


northwest_sf$re_cyclists_adjusted <- northwest_models_2$models$Adjusted2$summary.random$ui[1:nrow(northwest_sf), "mean"]
ggplot(northwest_sf) + geom_sf(aes(fill = re_cyclists_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Cyclist - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```


#### Pedestrians

```{r, echo = FALSE, fig.width= 7.5, fig.height=10}
 summarise_models_details(northwest_models_3$models) %>% 
   flextable() %>%
      autofit() %>%
      hline(c(1,8,9))



northwest_sf$re_pedestrians_adjusted <- northwest_models_3$models$Adjusted2$summary.random$ui[1:nrow(northwest_sf), "mean"]
ggplot(northwest_sf) + geom_sf(aes(fill = re_pedestrians_adjusted)) +
  scale_fill_gradient2(
    midpoint = 0,
    low = "#009392",
    mid = "#f1eac8",
    high = "#d0587e"
  ) +
  theme_bw() +
  theme_void(base_size = 11) +
  theme(legend.position = "bottom", ) +
  labs(title = "Posterior mean of the BYM2 random effect", subtitle = "Fully Adjusted Model for Pedestrian - Motor Vehicle Claims") +
  coord_sf(crs = 26910) 
```

### Reproducibility receipt

```{r,	echo = FALSE, message = FALSE, warning = FALSE}

rt <- tictoc::toc()

paste0("Total run time: ", rt$callback_msg)
## datetime
Sys.time()

## repository
git2r::repository()

## Session info
sessionInfo()
```



<!-- ## Provincial Models -->

<!-- ```{r, echo = FALSE, fig.width= 7.5, fig.height=10} -->



<!-- ##### Define Spatial Neighrbourhoods -->
<!-- bc_da_sp <- as(bc_da, "Spatial") -->
<!-- bc_da_sp$ui <- 1:nrow(bc_da_sp@data) -->
<!-- coords <- coordinates(bc_da_sp) -->
<!-- bc_da_nb <- poly2nb(bc_da_sp, queen = TRUE,snap = 1) -->

<!-- bc_da_nb -->

<!-- #assign nearest neighbour for no links -->

<!-- bc_da_nb <- assign_nearest_neighbors(bc_da_nb,bc_da_sp) -->


<!-- bc_da_nb -->

<!-- bc_data <- bc_da %>% st_drop_geometry() %>% mutate(ui = nrow(.)) -->

<!-- ``` -->


<!-- ### BYM2 Models -->


<!-- ```{r} -->

<!-- nb2INLA("bc_da.adj", bc_da_nb) -->
<!-- g <- inla.read.graph(filename = "bc_da.adj") -->



<!-- # Model Set 1: Total Casualty Claim Crashes -->
<!-- bc_models_1 <- cma_models(bc_da_sp@data,"provincial","n_casualty_claims","vandix_z") -->

<!-- bc_all <- clean_fixed_effects(bc_models_1$fixed_effects) -->

<!-- map(bc_models_1$models, ~ summary(.x)) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- bc_models_2 <- cma_models(bc_da_sp@data,"provincial","n_cyclist_casualty_claims","vandix_z")  -->

<!-- bc_cyclist <- clean_fixed_effects(bc_models_2$fixed_effects) -->

<!-- map(bc_models_2$models,~summary(.x)) -->


<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- bc_models_3 <- cma_models(bc_da_sp@data,"provincial","n_pedestrian_casualty_claims","vandix_z")  -->

<!-- bc_pedestrian <- clean_fixed_effects(bc_models_3$fixed_effects) -->

<!-- map(bc_models_3$models,~summary(.x)) -->

<!-- bc_results <- bind_rows(bc_all %>% mutate(Region = "Provincial",Outcome = "All Injury Claims"), -->
<!--                          bc_cyclist %>% mutate(Region = "Provincial",Outcome = "Cyclist Injury Claims"), -->
<!--                          bc_pedestrian %>% mutate(Region = "Provincial",Outcome = "Pedestrian Injury Claims") -->
<!--                          ) %>% -->
<!--   filter(variable == "vandix_z") %>% -->
<!--   select(Region,Outcome,everything()) -->

<!-- ``` -->




<!-- ### Random Intercept and Random Slopes Model -->


<!-- ```{r} -->
<!-- bc_cma_clean <- bc_da %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   select(contains("n_casualty"),contains("n_cyclist"), contains("n_pedestrian"),vandix_z , ln_roads_km ,  -->
<!--                  roads_prop_highway_arterial_z , ale_index_z ,  -->
<!--                  canbics_index_z , population_z,cma_name) %>%  -->
<!--   na.omit() %>%  -->
<!--   as_tibble() -->

<!-- library(lme4) -->


<!-- overdisp_fun <- function(model) { -->
<!--   ## number of variance parameters in -->
<!--   ##   an n-by-n variance-covariance matrix -->
<!--   vpars <- function(m) { -->
<!--     nrow(m)*(nrow(m)+1)/2 -->
<!--   } -->
<!--   model.df <- sum(sapply(VarCorr(model),vpars))+length(fixef(model)) -->
<!--   (rdf <- nrow(model@frame)-model.df) -->
<!--   rp <- residuals(model) -->
<!--   Pearson.chisq <- sum(rp^2) -->
<!--   prat <- Pearson.chisq/rdf -->
<!--   pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE,log.p=TRUE) -->
<!--   c(chisq=Pearson.chisq,ratio=prat,p=exp(pval),logp=pval) -->
<!-- } -->

<!-- # Poisson Random Intercepts -->
<!-- p_ri <- glmer(n_casualty_claims ~ vandix_z + (1 | cma_name),  -->
<!--                  family = poisson,  -->
<!--                  data = bc_cma_clean) -->

<!-- summary(p_ri) -->

<!-- ranef(p_ri) -->

<!-- overdisp_fun(p_ri) -->


<!-- # Poisson Random Intercepts and Random Slopes - Correlated -->
<!-- p_ri_rs_c <- glmer( -->
<!--   n_casualty_claims ~ vandix_z + (1 + vandix_z | cma_name), -->
<!--   family = poisson, -->
<!--   data = bc_cma_clean -->
<!-- ) -->

<!-- summary(p_ri_rs_c) -->

<!-- ranef(p_ri_rs_c) -->

<!-- overdisp_fun(p_ri_rs_c) -->

<!-- anova(p_ri,p_ri_rs,p_ri_rs_c) -->


<!-- # Poisson Random Intercepts and Random Slopes for vandix and ln_roads - Uncorrelated -->
<!-- p_ri_rs_m2 <- glmer( -->
<!--   n_casualty_claims ~ vandix_z + ln_roads_km + (1 | cma_name) + (0 + vandix_z | cma_name) + (0 + ln_roads_km | cma_name), -->
<!--   family = poisson, -->
<!--   data = bc_cma_clean -->
<!-- ) -->

<!-- summary(p_ri_rs_m2) -->
<!-- ranef(p_ri_rs_m2) -->

<!-- anova(p_ri_rs,p_ri_rs_m2) -->

<!-- overdisp_fun(p_ri_rs_m2) -->

<!-- library(broom.mixed) -->

<!-- tidy(p_ri_rs_m2,effects="fixed",conf.int=TRUE,exponentiate = TRUE) %>%  -->
<!--   filter(term == "vandix_z") -->


<!-- tidy(p_ri_rs_m2,effects="ran_vals",conf.int=TRUE) %>%  -->
<!--   filter(term == "vandix_z") -->


<!-- tidy(p_ri_rs_m2,effects="ran_coefs") %>%  -->
<!--   filter(term == "vandix_z") %>%  -->
<!--   mutate(estimate_exp = exp(estimate)) %>%  -->
<!--   flextable() -->

<!-- # Negative Binomial Random Intercepts and Random Slopes for vandix and ln_roads -->
<!-- nb_ri_rs_m1 <- glmer.nb( -->
<!--   n_casualty_claims ~ vandix_z + ln_roads_km + (1 | cma_name) + (0 + vandix_z | cma_name) + (0 + ln_roads_km | cma_name), -->
<!--   data = bc_cma_clean -->
<!-- ) -->

<!-- summary(nb_ri_rs_m1) -->
<!-- ranef(nb_ri_rs_m1) -->

<!-- anova(p_ri_rs_m2,nb_ri_rs_m1) -->

<!-- overdisp_fun(nb_ri_rs_m1) %>% round(.,5) -->



<!-- tidy(nb_ri_rs_m1,effects="fixed",conf.int=TRUE,exponentiate = TRUE) %>%  -->
<!--   filter(term == "vandix_z") -->


<!-- tidy(nb_ri_rs_m1,effects="ran_vals",conf.int=TRUE) %>%  -->
<!--   filter(term == "vandix_z") -->


<!-- tidy(nb_ri_rs_m1,effects="ran_coefs") %>%  -->
<!--   filter(term == "vandix_z") %>%  -->
<!--   mutate(estimate_exp = exp(estimate)) %>%  -->
<!--   flextable() -->


<!-- # Negative Binomial Random Intercepts and Random Slopes for vandix and ln_roads adjusting for other variables -->

<!-- nb_ri_rs_m2 <- glmmTMB( -->
<!--   n_casualty_claims ~ vandix_z + ln_roads_km + roads_prop_highway_arterial_z + population_z +  -->
<!--     (1 | cma_name) + (0 + vandix_z | cma_name) + (0 + ln_roads_km | cma_name), -->
<!--   family = nbinom2, -->
<!--   data = bc_cma_clean -->
<!-- ) -->

<!-- summary(nb_ri_rs_m2) -->
<!-- ranef(nb_ri_rs_m2) -->

<!-- tidy(nb_ri_rs_m2,effects="fixed",conf.int=TRUE,exponentiate = TRUE) %>%  -->
<!--   filter(term == "vandix_z") -->


<!-- tidy(nb_ri_rs_m2,effects="ran_vals",conf.int=TRUE) %>%  -->
<!--   filter(term == "vandix_z") %>%  -->
<!--   flextable() -->


<!-- tidy(nb_ri_rs_m2,effects="ran_vals",component = "cond") %>% print(n = 100) -->
<!--   filter(term == "vandix_z") %>%  -->
<!--   mutate(estimate_exp = exp(estimate)) %>%  -->
<!--   flextable() -->




<!-- library(marginaleffects) -->
<!-- library(ggrepel) -->

<!-- ############# Unadjusted Model  -->

<!-- pred1 <- predictions(unadjusted_model, -->
<!--                      newdata = datagrid(cma_name = bc_cma_clean$cma_name, -->
<!--                                         vandix_z = min(bc_cma_clean$vandix_z):max(bc_cma_clean$vandix_z))) -->

<!-- # Summarize to get the last estimate for each line -->
<!-- labels_data <- pred1 %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate(pop_quantile = ntile(desc(cma_population), 4)) %>% -->
<!--   group_by(cma_name, pop_quantile) %>% -->
<!--   summarise( -->
<!--     vandix_z = last(vandix_z), -->
<!--     estimate = last(estimate), -->
<!--     cma_population = last(cma_population), -->
<!--     .groups = 'drop' -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) -->


<!-- color_palette <- rep(brewer.pal(n = 7, name = "Set2"),4) -->

<!-- set.seed(2) -->
<!-- pred1 %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate( -->
<!--     pop_quantile = ntile(desc(cma_population), 4), -->
<!--     cma_name = fct_reorder(cma_name, cma_population, .desc = TRUE) -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) %>%  -->
<!--   ungroup() %>% -->
<!--   ggplot(aes(x = vandix_z, y = estimate, color = cma_name)) + -->
<!--   geom_line(size = 1) +  # Increase line size for better visibility -->
<!--   geom_label_repel( -->
<!--     data = labels_data, -->
<!--     aes(label = cma_name), -->
<!--     force_pull   = 0, -->
<!--     # do not pull toward data points, -->
<!--     nudge_x = 2, -->
<!--     direction = "y", -->
<!--     segment.size = 0.2, -->
<!--     hjust = 0 -->
<!--   ) + -->
<!--   xlim(-3.5, 11)  + -->
<!--   labs(y = "Predicted Claims", x = "VanDIX", title = "Unadjusted Estimates") + -->
<!--   theme_minimal(base_size = 14) +  # Use a clean theme and increase base font size -->
<!--   theme(legend.title = element_blank(), # Remove legend title for simplicity -->
<!--         legend.position = "none") +  # Position legend to the bottom -->
<!--   facet_wrap( ~ pop_label,nrow=1) + # Facet by population quantile -->
<!--   scale_color_manual(values = color_palette)  # Use the Set1 color palette -->


<!-- # Fit the Poisson mixed effects model -->
<!-- minimal_adjusted_model <- glmer(n_casualty_claims ~ vandix_z + ln_roads_km + (vandix_z + ln_roads_km | cma_name),  -->
<!--                  family = poisson,  -->
<!--                  data = bc_cma_clean) -->

<!-- summary(minimal_adjusted_model) -->

<!-- coef(minimal_adjusted_model)$cma_name -->

<!-- me_data <- datagrid(model = minimal_adjusted_model, -->
<!--                   cma_name = bc_cma_clean$cma_name, -->
<!--                   vandix_z = floor(min(bc_cma_clean$vandix_z)):ceiling(max(bc_cma_clean$vandix_z)) -->
<!-- ) -->

<!-- me_data$estimate <- predict(minimal_adjusted_model,newdata=me_data, re.form=NULL, type = "response") -->

<!-- # Summarize to get the last estimate for each line -->
<!-- labels_data <- me_data %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate(pop_quantile = ntile(desc(cma_population), 4)) %>% -->
<!--   group_by(cma_name, pop_quantile) %>% -->
<!--   summarise( -->
<!--     vandix_z = last(vandix_z), -->
<!--     estimate = last(estimate), -->
<!--     cma_population = last(cma_population), -->
<!--     .groups = 'drop' -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) -->


<!-- color_palette <- rep(brewer.pal(n = 7, name = "Set2"),4) -->

<!-- set.seed(2) -->
<!-- me_data %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate( -->
<!--     pop_quantile = ntile(desc(cma_population), 4), -->
<!--     cma_name = fct_reorder(cma_name, cma_population, .desc = TRUE) -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) %>%  -->
<!--   ungroup() %>% -->
<!--   ggplot(aes(x = vandix_z, y = estimate, color = cma_name)) + -->
<!--   geom_line(size = 1) +  # Increase line size for better visibility -->
<!--   geom_label_repel( -->
<!--     data = labels_data, -->
<!--     aes(label = cma_name), -->
<!--     force_pull   = 0, -->
<!--     # do not pull toward data points, -->
<!--     nudge_x = 2, -->
<!--     direction = "y", -->
<!--     segment.size = 0.2, -->
<!--     hjust = 0 -->
<!--   ) + -->
<!--   xlim(-4, 11)  + -->
<!--   labs(y = "Predicted Claims", x = "VanDIX", title = "Minimally Adjusted Estimates") + -->
<!--   theme_minimal(base_size = 14) +  # Use a clean theme and increase base font size -->
<!--   theme(legend.title = element_blank(), # Remove legend title for simplicity -->
<!--         legend.position = "none") +  # Position legend to the bottom -->
<!--   facet_wrap( ~ pop_label,nrow=1) + # Facet by population quantile -->
<!--   scale_color_manual(values = color_palette)  # Use the Set1 color palette -->


<!-- overdisp_fun(minimal_adjusted_model) -->



<!-- # Fit the Poisson mixed effects model -->
<!-- adjusted_model <- glmer(n_casualty_claims ~ vandix_z + ln_roads_km + roads_prop_highway_arterial_z + ale_index_z + canbics_index_z + population_100 + (vandix_z + ln_roads_km | cma_name),  -->
<!--                  family = poisson,  -->
<!--                  data = bc_cma_clean) -->

<!-- summary(adjusted_model) -->

<!-- coef(adjusted_model)$cma_name -->

<!-- me_data <- datagrid(model = adjusted_model, -->
<!--                   cma_name = bc_cma_clean$cma_name, -->
<!--                   vandix_z = floor(min(bc_cma_clean$vandix_z)):ceiling(max(bc_cma_clean$vandix_z)) -->
<!-- ) -->

<!-- me_data$estimate <- predict(minimal_adjusted_model,newdata=me_data, re.form=NULL, type = "response") -->

<!-- # Summarize to get the last estimate for each line -->
<!-- labels_data <- me_data %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate(pop_quantile = ntile(desc(cma_population), 4)) %>% -->
<!--   group_by(cma_name, pop_quantile) %>% -->
<!--   summarise( -->
<!--     vandix_z = last(vandix_z), -->
<!--     estimate = last(estimate), -->
<!--     cma_population = last(cma_population), -->
<!--     .groups = 'drop' -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) -->


<!-- color_palette <- rep(brewer.pal(n = 7, name = "Set2"),4) -->

<!-- set.seed(2) -->
<!-- me_data %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate( -->
<!--     pop_quantile = ntile(desc(cma_population), 4), -->
<!--     cma_name = fct_reorder(cma_name, cma_population, .desc = TRUE) -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) %>%  -->
<!--   ungroup() %>% -->
<!--   ggplot(aes(x = vandix_z, y = estimate, color = cma_name)) + -->
<!--   geom_line(size = 1) +  # Increase line size for better visibility -->
<!--   geom_label_repel( -->
<!--     data = labels_data, -->
<!--     aes(label = cma_name), -->
<!--     force_pull   = 0, -->
<!--     # do not pull toward data points, -->
<!--     nudge_x = 2, -->
<!--     direction = "y", -->
<!--     segment.size = 0.2, -->
<!--     hjust = 0 -->
<!--   ) + -->
<!--   xlim(-4, 11)  + -->
<!--   labs(y = "Predicted Claims", x = "VanDIX", title = "Minimally Adjusted Estimates") + -->
<!--   theme_minimal(base_size = 14) +  # Use a clean theme and increase base font size -->
<!--   theme(legend.title = element_blank(), # Remove legend title for simplicity -->
<!--         legend.position = "none") +  # Position legend to the bottom -->
<!--   facet_wrap( ~ pop_label,nrow=1) + # Facet by population quantile -->
<!--   scale_color_manual(values = color_palette)  # Use the Set1 color palette -->


<!-- overdisp_fun(adjusted_model) -->




<!-- # Negative binomial GLMM using the function glmer.nb() -->
<!-- adjusted_model <- glmer.nb( -->
<!--   n_casualty_claims ~ vandix_z + ln_roads_km + roads_prop_highway_arterial_z + ale_index_z + canbics_index_z + population_100 + (vandix_z + ln_roads_km | -->
<!--                                                                                                                                    cma_name), -->
<!--   data = bc_cma_clean, -->
<!--   control = glmerControl(optimizer = "bobyqa") -->
<!-- ) -->


<!-- # Fit the Poisson mixed effects model -->
<!-- adjusted_model <- glmer(n_casualty_claims ~ vandix_z + ln_roads_km + roads_prop_highway_arterial_z + ale_index_z + canbics_index_z + population_100 + (vandix_z + ln_roads_km | cma_name),  -->
<!--                  family = poisson,  -->
<!--                  data = bc_cma_clean) -->

<!-- summary(adjusted_model) -->

<!-- coef(adjusted_model)$cma_name -->

<!-- me_data <- datagrid(model = adjusted_model, -->
<!--                   cma_name = bc_cma_clean$cma_name, -->
<!--                   vandix_z = floor(min(bc_cma_clean$vandix_z)):ceiling(max(bc_cma_clean$vandix_z)) -->
<!-- ) -->

<!-- me_data$estimate <- predict(minimal_adjusted_model,newdata=me_data, re.form=NULL, type = "response") -->

<!-- # Summarize to get the last estimate for each line -->
<!-- labels_data <- me_data %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate(pop_quantile = ntile(desc(cma_population), 4)) %>% -->
<!--   group_by(cma_name, pop_quantile) %>% -->
<!--   summarise( -->
<!--     vandix_z = last(vandix_z), -->
<!--     estimate = last(estimate), -->
<!--     cma_population = last(cma_population), -->
<!--     .groups = 'drop' -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) -->


<!-- color_palette <- rep(brewer.pal(n = 7, name = "Set2"),4) -->

<!-- set.seed(2) -->
<!-- me_data %>% -->
<!--   left_join(cma_name) %>% -->
<!--   mutate( -->
<!--     pop_quantile = ntile(desc(cma_population), 4), -->
<!--     cma_name = fct_reorder(cma_name, cma_population, .desc = TRUE) -->
<!--   ) %>% -->
<!--   group_by(pop_quantile) %>% -->
<!--   mutate(pop_label = paste0( -->
<!--     "Population (1000s) = ", -->
<!--     round(max(cma_population) / 1000), -->
<!--     " to ", -->
<!--     round(min(cma_population) / 1000)), -->
<!--     pop_label = fct_reorder(pop_label,pop_quantile) -->
<!--   ) %>%  -->
<!--   ungroup() %>% -->
<!--   ggplot(aes(x = vandix_z, y = estimate, color = cma_name)) + -->
<!--   geom_line(size = 1) +  # Increase line size for better visibility -->
<!--   geom_label_repel( -->
<!--     data = labels_data, -->
<!--     aes(label = cma_name), -->
<!--     force_pull   = 0, -->
<!--     # do not pull toward data points, -->
<!--     nudge_x = 2, -->
<!--     direction = "y", -->
<!--     segment.size = 0.2, -->
<!--     hjust = 0 -->
<!--   ) + -->
<!--   xlim(-4, 11)  + -->
<!--   labs(y = "Predicted Claims", x = "VanDIX", title = "Minimally Adjusted Estimates") + -->
<!--   theme_minimal(base_size = 14) +  # Use a clean theme and increase base font size -->
<!--   theme(legend.title = element_blank(), # Remove legend title for simplicity -->
<!--         legend.position = "none") +  # Position legend to the bottom -->
<!--   facet_wrap( ~ pop_label,nrow=1) + # Facet by population quantile -->
<!--   scale_color_manual(values = color_palette)  # Use the Set1 color palette -->


<!-- overdisp_fun(adjusted_model) -->




<!-- ``` -->









<!-- ```{r} -->
<!-- cma_pop %>% remove_missing() %>% print(n = 100) -->

<!-- ``` -->

<!-- ###### Supplementary Material  -->





<!-- # Victoria  ---------------------------------------------------- -->

<!-- victoria <- bc_da %>%  -->
<!--   filter(cma_name == "Victoria") -->

<!-- ###### Descriptive Statistics  -->

<!-- victoria %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ##### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = victoria, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = victoria, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = victoria, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ##### Define Spatial Neighrbourhoods -->

<!-- victoria <- as(victoria, "Spatial") -->
<!-- victoria$ui <- 1:nrow(victoria@data) -->
<!-- coords <- coordinates(victoria) -->
<!-- victoria_nb <- poly2nb(victoria, queen = TRUE) -->
<!-- victoria_nb -->

<!-- plot(victoria, border = grey(0.5)) -->
<!-- plot(victoria_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- # victoria_nb_m <- knearneigh(coords, k = 1)  -->
<!-- # victoria_centroids <- coordinates(victoria) -->
<!-- # victoria_nb_m <- knearneigh(victoria_centroids, k = 1) -->
<!-- #  -->
<!-- # victoria_nb[2938] <- victoria_nb_m$nn[victoria_nb_m$nn[2938,], ] -->
<!-- #  -->
<!-- # victoria_nb <- make.sym.nb(victoria_nb) -->

<!-- nb2INLA("victoria.adj", victoria_nb) -->
<!-- g <- inla.read.graph(filename = "victoria.adj") -->


<!-- descriptives %>%  -->
<!--   filter(cma=="Victoria") %>%  -->
<!--   print(n = 100) -->



<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(victoria_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(victoria$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(victoria$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(victoria$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- vic_models_1 <- cma_models(victoria@data,"victoria","n_casualty_claims","vandix_z") -->
<!-- vic_all <- clean_fixed_effects(vic_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- vic_models_2 <- cma_models(victoria@data,"victoria","n_cyclist_casualty_claims","vandix_z") -->
<!-- vic_cyclist <- clean_fixed_effects(vic_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- vic_models_3 <- cma_models(victoria@data,"victoria","n_pedestrian_casualty_claims","vandix_z") -->
<!-- vic_pedestrian <- clean_fixed_effects(vic_models_3$fixed_effects) -->


<!-- vic_results <- bind_rows(vic_all %>% mutate(CMA = "Victoria",Outcome = "All Injury Claims"), -->
<!--                          vic_cyclist %>% mutate(CMA = "Victoria", Outcome = "Cyclist Injury Claims"), -->
<!--                          vic_pedestrian %>% mutate(CMA = "Victoria", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->




<!-- # Abbotsford - Mission ------------------------------------------------------------------------- -->


<!-- abbotsford <- bc_da %>%  -->
<!--   filter(cma_name == "Abbotsford - Mission") -->

<!-- ###### Descriptive Statistics  -->

<!-- abbotsford %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ###### Maps -->


<!-- ggplot() +  -->
<!--   geom_sf(data = abbotsford, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = abbotsford, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = abbotsford, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- abbotsford <- as(abbotsford, "Spatial") -->
<!-- abbotsford$ui <- 1:nrow(abbotsford@data) -->
<!-- coords <- coordinates(abbotsford) -->
<!-- abbotsford_nb <- poly2nb(abbotsford, queen = TRUE) -->
<!-- abbotsford_nb -->

<!-- plot(abbotsford, border = grey(0.5)) -->
<!-- plot(abbotsford_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- # abbotsford_nb_m <- knearneigh(coords, k = 1)  -->
<!-- # abbotsford_centroids <- coordinates(abbotsford) -->
<!-- # abbotsford_nb_m <- knearneigh(abbotsford_centroids, k = 1) -->
<!-- #  -->
<!-- # abbotsford_nb[2938] <- abbotsford_nb_m$nn[abbotsford_nb_m$nn[2938,], ] -->
<!-- #  -->
<!-- # abbotsford_nb <- make.sym.nb(abbotsford_nb) -->

<!-- nb2INLA("abbotsford.adj", abbotsford_nb) -->
<!-- g <- inla.read.graph(filename = "abbotsford.adj") -->


<!-- descriptives %>%  -->
<!--   filter(cma=="Abbotsford - Mission") %>%  -->
<!--   print(n = 100) -->



<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(abbotsford_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(abbotsford$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(abbotsford$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(abbotsford$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- abby_models_1 <- cma_models(abbotsford@data,"abbotsford","n_casualty_claims","vandix_z") -->
<!-- abby_all <- clean_fixed_effects(abby_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- abby_models_2 <- cma_models(abbotsford@data,"abbotsford","n_cyclist_casualty_claims","vandix_z") -->
<!-- abby_cyclist <- clean_fixed_effects(abby_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- abby_models_3 <- cma_models(abbotsford@data,"abbotsford","n_pedestrian_casualty_claims","vandix_z") -->
<!-- abby_pedestrian <- clean_fixed_effects(abby_models_3$fixed_effects) -->


<!-- abby_results <- bind_rows(abby_all %>% mutate(CMA = "Abbotsford - Mission",Outcome = "All Injury Claims"), -->
<!--                          abby_cyclist %>% mutate(CMA = "Abbotsford - Mission", Outcome = "Cyclist Injury Claims"), -->
<!--                          abby_pedestrian %>% mutate(CMA = "Abbotsford - Mission", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->


<!-- # Kelowna ------------------------------------------------------------------------- -->

<!-- kelowna <- bc_da %>%  -->
<!--   filter(cma_name == "Kelowna") -->

<!-- ###### Descriptive Statistics  -->

<!-- kelowna %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- kelowna <- as(kelowna, "Spatial") -->
<!-- kelowna$ui <- 1:nrow(kelowna@data) -->
<!-- coords <- coordinates(kelowna) -->
<!-- kelowna_nb <- poly2nb(kelowna, queen = TRUE) -->
<!-- kelowna_nb -->

<!-- plot(kelowna, border = grey(0.5)) -->
<!-- plot(kelowna_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- # kelowna_nb_m <- knearneigh(coords, k = 1)  -->
<!-- # kelowna_centroids <- coordinates(kelowna) -->
<!-- # kelowna_nb_m <- knearneigh(kelowna_centroids, k = 1) -->
<!-- #  -->
<!-- # kelowna_nb[2938] <- kelowna_nb_m$nn[kelowna_nb_m$nn[2938,], ] -->
<!-- #  -->
<!-- # kelowna_nb <- make.sym.nb(kelowna_nb) -->

<!-- nb2INLA("kelowna.adj", kelowna_nb) -->
<!-- g <- inla.read.graph(filename = "kelowna.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Kelowna") %>%  -->
<!--   print(n = 100) -->



<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(kelowna_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(kelowna$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(kelowna$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(kelowna$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- kel_models_1 <- cma_models(kelowna@data,"kelowna","n_casualty_claims","vandix_z") -->
<!-- kel_all <- clean_fixed_effects(kel_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- kel_models_2 <- cma_models(kelowna@data,"kelowna","n_cyclist_casualty_claims","vandix_z") -->
<!-- kel_cyclist <- clean_fixed_effects(kel_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- kel_models_3 <- cma_models(kelowna@data,"kelowna","n_pedestrian_casualty_claims","vandix_z") -->
<!-- kel_pedestrian <- clean_fixed_effects(kel_models_3$fixed_effects) -->


<!-- kel_results <- bind_rows(kel_all %>% mutate(CMA = "Kelowna",Outcome = "All Injury Claims"), -->
<!--                           kel_cyclist %>% mutate(CMA = "Kelowna", Outcome = "Cyclist Injury Claims"), -->
<!--                           kel_pedestrian %>% mutate(CMA = "Kelowna", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->




<!-- ### CMA Results  -->


<!-- # Nanaimo ------------------------------------------------------------------------- -->

<!-- nanaimo <- bc_da %>%  -->
<!--   filter(cma_name == "Nanaimo") -->

<!-- ###### Descriptive Statistics  -->

<!-- nanaimo %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = nanaimo, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = nanaimo, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = nanaimo, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- nanaimo <- as(nanaimo, "Spatial") -->
<!-- nanaimo$ui <- 1:nrow(nanaimo@data) -->
<!-- coords <- coordinates(nanaimo) -->
<!-- nanaimo_nb <- poly2nb(nanaimo, queen = TRUE) -->
<!-- nanaimo_nb -->

<!-- plot(nanaimo, border = grey(0.5)) -->
<!-- plot(nanaimo_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nanaimo_nb_m <- knearneigh(coords, k = 1) -->
<!-- nanaimo_centroids <- coordinates(nanaimo) -->
<!-- nanaimo_nb_m <- knearneigh(nanaimo_centroids, k = 1) -->

<!-- nanaimo_nb[9] <- nanaimo_nb_m$nn[nanaimo_nb_m$nn[9,], ] -->

<!-- nanaimo_nb <- make.sym.nb(nanaimo_nb) -->
<!-- nanaimo_nb -->

<!-- plot(nanaimo, border = grey(0.5)) -->
<!-- plot(nanaimo_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->


<!-- nb2INLA("nanaimo.adj", nanaimo_nb) -->
<!-- g <- inla.read.graph(filename = "nanaimo.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Nanaimo") %>%  -->
<!--   print(n = 100) -->



<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(nanaimo_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(nanaimo$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(nanaimo$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(nanaimo$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- nan_models_1 <- cma_models(nanaimo@data,"nanaimo","n_casualty_claims","vandix_z") -->
<!-- nan_all <- clean_fixed_effects(nan_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- nan_models_2 <- cma_models(nanaimo@data,"nanaimo","n_cyclist_casualty_claims","vandix_z") -->
<!-- nan_cyclist <- clean_fixed_effects(nan_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- nan_models_3 <- cma_models(nanaimo@data,"nanaimo","n_pedestrian_casualty_claims","vandix_z") -->
<!-- nan_pedestrian <- clean_fixed_effects(nan_models_3$fixed_effects) -->


<!-- nan_results <- bind_rows(nan_all %>% mutate(CMA = "Nanaimo",Outcome = "All Injury Claims"), -->
<!--                          nan_cyclist %>% mutate(CMA = "Nanaimo", Outcome = "Cyclist Injury Claims"), -->
<!--                          nan_pedestrian %>% mutate(CMA = "Nanaimo", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->


<!-- # Chilliwack ------------------------------------------------------------------------- -->

<!-- chilliwack <- bc_da %>%  -->
<!--   filter(cma_name == "Chilliwack") -->

<!-- ###### Descriptive Statistics  -->

<!-- chilliwack %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = chilliwack, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = chilliwack, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = chilliwack, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->




<!-- ##### Define Spatial Neighrbourhoods -->

<!-- chilliwack <- as(chilliwack, "Spatial") -->
<!-- chilliwack$ui <- 1:nrow(chilliwack@data) -->
<!-- coords <- coordinates(chilliwack) -->
<!-- chilliwack_nb <- poly2nb(chilliwack, queen = TRUE) -->
<!-- chilliwack_nb -->

<!-- plot(chilliwack, border = grey(0.5)) -->
<!-- plot(chilliwack_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->



<!-- nb2INLA("chilliwack.adj", chilliwack_nb) -->
<!-- g <- inla.read.graph(filename = "chilliwack.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Chilliwack") %>%  -->
<!--   print(n = 100) -->



<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(chilliwack_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(chilliwack$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(chilliwack$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(chilliwack$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- chi_models_1 <- cma_models(chilliwack@data,"chilliwack","n_casualty_claims","vandix_z") -->
<!-- chi_all <- clean_fixed_effects(chi_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- chi_models_2 <- cma_models(chilliwack@data,"chilliwack","n_cyclist_casualty_claims","vandix_z") -->
<!-- chi_cyclist <- clean_fixed_effects(chi_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- chi_models_3 <- cma_models(chilliwack@data,"chilliwack","n_pedestrian_casualty_claims","vandix_z") -->
<!-- chi_pedestrian <- clean_fixed_effects(chi_models_3$fixed_effects) -->


<!-- chi_results <- bind_rows(chi_all %>% mutate(CMA = "Chilliwack",Outcome = "All Injury Claims"), -->
<!--                          chi_cyclist %>% mutate(CMA = "Chilliwack", Outcome = "Cyclist Injury Claims"), -->
<!--                          chi_pedestrian %>% mutate(CMA = "Chilliwack", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->

<!-- # Kamloops ------------------------------------------------------------------------- -->

<!-- kamloops <- bc_da %>%  -->
<!--   filter(cma_name == "Kamloops") -->

<!-- ###### Descriptive Statistics  -->

<!-- kamloops %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = kamloops, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = kamloops, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = kamloops, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->




<!-- ##### Define Spatial Neighrbourhoods -->

<!-- kamloops <- as(kamloops, "Spatial") -->
<!-- kamloops$ui <- 1:nrow(kamloops@data) -->
<!-- coords <- coordinates(kamloops) -->
<!-- kamloops_nb <- poly2nb(kamloops, queen = TRUE) -->
<!-- kamloops_nb -->

<!-- plot(kamloops, border = grey(0.5)) -->
<!-- plot(kamloops_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("kamloops.adj", kamloops_nb) -->
<!-- g <- inla.read.graph(filename = "kamloops.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Kamloops") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(kamloops_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(kamloops$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(kamloops$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(kamloops$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- kam_models_1 <- cma_models(kamloops@data,"kamloops","n_casualty_claims","vandix_z") -->
<!-- kam_all <- clean_fixed_effects(kam_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- kam_models_2 <- cma_models(kamloops@data,"kamloops","n_cyclist_casualty_claims","vandix_z") -->
<!-- kam_cyclist <- clean_fixed_effects(kam_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- kam_models_3 <- cma_models(kamloops@data,"kamloops","n_pedestrian_casualty_claims","vandix_z") -->
<!-- kam_pedestrian <- clean_fixed_effects(kam_models_3$fixed_effects) -->


<!-- kam_results <- bind_rows(kam_all %>% mutate(CMA = "Kamloops",Outcome = "All Injury Claims"), -->
<!--                          kam_cyclist %>% mutate(CMA = "Kamloops", Outcome = "Cyclist Injury Claims"), -->
<!--                          kam_pedestrian %>% mutate(CMA = "Kamloops", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->


<!-- # Prince George ------------------------------------------------------------------------- -->

<!-- pg <- bc_da %>%  -->
<!--   filter(cma_name == "Prince George ") -->

<!-- ###### Descriptive Statistics  -->

<!-- pg %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = pg, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = pg, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = pg, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- pg <- as(pg, "Spatial") -->
<!-- pg$ui <- 1:nrow(pg@data) -->
<!-- coords <- coordinates(pg) -->
<!-- pg_nb <- poly2nb(pg, queen = TRUE) -->
<!-- pg_nb -->

<!-- plot(pg, border = grey(0.5)) -->
<!-- plot(pg_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("pg.adj", pg_nb) -->
<!-- g <- inla.read.graph(filename = "pg.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Prince George ") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(pg_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(pg$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(pg$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(pg$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- pg_models_1 <- cma_models(pg@data,"pg","n_casualty_claims","vandix_z") -->
<!-- pg_all <- clean_fixed_effects(pg_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- pg_models_2 <- cma_models(pg@data,"pg","n_cyclist_casualty_claims","vandix_z") -->
<!-- pg_cyclist <- clean_fixed_effects(pg_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- pg_models_3 <- cma_models(pg@data,"pg","n_pedestrian_casualty_claims","vandix_z") -->
<!-- pg_pedestrian <- clean_fixed_effects(pg_models_3$fixed_effects) -->


<!-- pg_results <- bind_rows(pg_all %>% mutate(CMA = "Prince George",Outcome = "All Injury Claims"), -->
<!--                          pg_cyclist %>% mutate(CMA = "Prince George", Outcome = "Cyclist Injury Claims"), -->
<!--                          pg_pedestrian %>% mutate(CMA = "Prince George", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->


<!-- # Vernon  ------------------------------------------------------------------------- -->

<!-- vernon <- bc_da %>%  -->
<!--   filter(cma_name == "Vernon ") -->

<!-- ###### Descriptive Statistics  -->

<!-- vernon %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = vernon, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = vernon, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = vernon, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ##### Define Spatial Neighrbourhoods -->

<!-- vernon <- as(vernon, "Spatial") -->
<!-- vernon$ui <- 1:nrow(vernon@data) -->
<!-- coords <- coordinates(vernon) -->
<!-- vernon_nb <- poly2nb(vernon, queen = TRUE) -->
<!-- vernon_nb -->

<!-- plot(vernon, border = grey(0.5)) -->
<!-- plot(vernon_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->


<!-- vernon_nb_m <- knearneigh(coords, k = 1)  -->
<!-- vernon_centroids <- coordinates(vancouver) -->
<!-- vernon_nb_m <- knearneigh(vernon_centroids, k = 1) -->

<!-- vernon_nb[68] <- vernon_nb_m$nn[105,] #[vernon_nb_m$nn[68,], ] -->

<!-- vernon_nb <- make.sym.nb(vernon_nb) -->

<!-- plot(vernon, border = grey(0.5)) -->
<!-- plot(vernon_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("vernon.adj", vernon_nb) -->
<!-- g <- inla.read.graph(filename = "vernon.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Vernon ") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(vernon_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(vernon$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(vernon$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(vernon$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- ver_models_1 <- cma_models(vernon@data,"vernon","n_casualty_claims","vandix_z") -->
<!-- ver_all <- clean_fixed_effects(ver_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- ver_models_2 <- cma_models(vernon@data,"vernon","n_cyclist_casualty_claims","vandix_z") -->
<!-- ver_cyclist <- clean_fixed_effects(ver_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- ver_models_3 <- cma_models(vernon@data,"vernon","n_pedestrian_casualty_claims","vandix_z") -->
<!-- ver_pedestrian <- clean_fixed_effects(ver_models_3$fixed_effects) -->


<!-- ver_results <- bind_rows(ver_all %>% mutate(CMA = "Vernon",Outcome = "All Injury Claims"), -->
<!--                          ver_cyclist %>% mutate(CMA = "Vernon", Outcome = "Cyclist Injury Claims"), -->
<!--                          ver_pedestrian %>% mutate(CMA = "Vernon", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->


<!-- # Courtenay   ------------------------------------------------------------------------- -->

<!-- courtenay <- bc_da %>%  -->
<!--   filter(cma_name == "Courtenay ") -->

<!-- ###### Descriptive Statistics  -->

<!-- courtenay %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->


<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = courtenay, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = courtenay, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = courtenay, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- courtenay <- as(courtenay, "Spatial") -->
<!-- courtenay$ui <- 1:nrow(courtenay@data) -->
<!-- coords <- coordinates(courtenay) -->
<!-- courtenay_nb <- poly2nb(courtenay, queen = TRUE) -->
<!-- courtenay_nb -->

<!-- plot(courtenay, border = grey(0.5)) -->
<!-- plot(courtenay_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("courtenay.adj", courtenay_nb) -->
<!-- g <- inla.read.graph(filename = "courtenay.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Courtenay ") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(courtenay_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(courtenay$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(courtenay$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(courtenay$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- cou_models_1 <- cma_models(courtenay@data,"courtenay","n_casualty_claims","vandix_z") -->
<!-- cou_all <- clean_fixed_effects(cou_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- cou_models_2 <- cma_models(courtenay@data,"courtenay","n_cyclist_casualty_claims","vandix_z") -->
<!-- cou_cyclist <- clean_fixed_effects(cou_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- cou_models_3 <- cma_models(courtenay@data,"courtenay","n_pedestrian_casualty_claims","vandix_z") -->
<!-- cou_pedestrian <- clean_fixed_effects(cou_models_3$fixed_effects) -->


<!-- cou_results <- bind_rows(cou_all %>% mutate(CMA = "Courtenay",Outcome = "All Injury Claims"), -->
<!--                          cou_cyclist %>% mutate(CMA = "Courtenay", Outcome = "Cyclist Injury Claims"), -->
<!--                          cou_pedestrian %>% mutate(CMA = "Courtenay", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->

<!-- # Duncan   ------------------------------------------------------------------------- -->

<!-- duncan <- bc_da %>%  -->
<!--   filter(cma_name == "Duncan ") -->

<!-- ###### Descriptive Statistics  -->

<!-- duncan %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->


<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = duncan, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = duncan, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = duncan, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- duncan <- as(duncan, "Spatial") -->
<!-- duncan$ui <- 1:nrow(duncan@data) -->
<!-- coords <- coordinates(duncan) -->
<!-- duncan_nb <- poly2nb(duncan, queen = TRUE) -->
<!-- duncan_nb -->

<!-- plot(duncan, border = grey(0.5)) -->
<!-- plot(duncan_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("duncan.adj", duncan_nb) -->
<!-- g <- inla.read.graph(filename = "duncan.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Duncan ") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(duncan_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(duncan$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(duncan$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(duncan$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- dun_models_1 <- cma_models(duncan@data,"duncan","n_casualty_claims","vandix_z") -->
<!-- dun_all <- clean_fixed_effects(dun_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- dun_models_2 <- cma_models(duncan@data,"duncan","n_cyclist_casualty_claims","vandix_z") -->
<!-- dun_cyclist <- clean_fixed_effects(dun_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- dun_models_3 <- cma_models(duncan@data,"duncan","n_pedestrian_casualty_claims","vandix_z") -->
<!-- dun_pedestrian <- clean_fixed_effects(dun_models_3$fixed_effects) -->


<!-- dun_results <- bind_rows(dun_all %>% mutate(CMA = "Duncan",Outcome = "All Injury Claims"), -->
<!--                          dun_cyclist %>% mutate(CMA = "Duncan", Outcome = "Cyclist Injury Claims"), -->
<!--                          dun_pedestrian %>% mutate(CMA = "Duncan", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->

<!-- # Penticton   ------------------------------------------------------------------------- -->

<!-- penticton <- bc_da %>%  -->
<!--   filter(cma_name == "Penticton ") -->

<!-- ###### Descriptive Statistics  -->

<!-- penticton %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->


<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = penticton, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = penticton, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = penticton, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- penticton <- as(penticton, "Spatial") -->
<!-- penticton$ui <- 1:nrow(penticton@data) -->
<!-- coords <- coordinates(penticton) -->
<!-- penticton_nb <- poly2nb(penticton, queen = TRUE) -->
<!-- penticton_nb -->

<!-- plot(penticton, border = grey(0.5)) -->
<!-- plot(penticton_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("penticton.adj", penticton_nb) -->
<!-- g <- inla.read.graph(filename = "penticton.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Penticton ") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(penticton_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(penticton$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(penticton$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(penticton$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->


<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- pen_models_1 <- cma_models(penticton@data,"penticton","n_casualty_claims","vandix_z") -->
<!-- pen_all <- clean_fixed_effects(pen_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- pen_models_2 <- cma_models(penticton@data,"penticton","n_cyclist_casualty_claims","vandix_z") -->
<!-- pen_cyclist <- clean_fixed_effects(pen_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- pen_models_3 <- cma_models(penticton@data,"penticton","n_pedestrian_casualty_claims","vandix_z") -->
<!-- pen_pedestrian <- clean_fixed_effects(pen_models_3$fixed_effects) -->


<!-- pen_results <- bind_rows(pen_all %>% mutate(CMA = "Penticton",Outcome = "All Injury Claims"), -->
<!--                          pen_cyclist %>% mutate(CMA = "Penticton", Outcome = "Cyclist Injury Claims"), -->
<!--                          pen_pedestrian %>% mutate(CMA = "Penticton", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->

<!-- # Campbell River  ------------------------------------------------------------------------- -->

<!-- campbell <- bc_da %>%  -->
<!--   filter(cma_name == "Campbell River ") -->

<!-- ###### Descriptive Statistics  -->

<!-- campbell %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--   ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->


<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = campbell, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = campbell, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = campbell, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- campbell <- as(campbell, "Spatial") -->
<!-- campbell$ui <- 1:nrow(campbell@data) -->
<!-- coords <- coordinates(campbell) -->
<!-- campbell_nb <- poly2nb(campbell, queen = TRUE) -->
<!-- campbell_nb -->

<!-- plot(campbell, border = grey(0.5)) -->
<!-- plot(campbell_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("campbell.adj", campbell_nb) -->
<!-- g <- inla.read.graph(filename = "campbell.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Campbell River ") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(campbell_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(campbell$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(campbell$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(campbell$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->

<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- camp_models_1 <- cma_models(campbell@data,"campbell","n_casualty_claims","vandix_z") -->
<!-- camp_all <- clean_fixed_effects(camp_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- camp_models_2 <- cma_models(campbell@data,"campbell","n_cyclist_casualty_claims","vandix_z") -->
<!-- camp_cyclist <- clean_fixed_effects(camp_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- camp_models_3 <- cma_models(campbell@data,"campbell","n_pedestrian_casualty_claims","vandix_z") -->
<!-- camp_pedestrian <- clean_fixed_effects(camp_models_3$fixed_effects) -->


<!-- camp_results <- bind_rows(camp_all %>% mutate(CMA = "Campbell River",Outcome = "All Injury Claims"), -->
<!--                          camp_cyclist %>% mutate(CMA = "Campbell River", Outcome = "Cyclist Injury Claims"), -->
<!--                          camp_pedestrian %>% mutate(CMA = "Campbell River", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->

<!-- # Parksville  ------------------------------------------------------------------------- -->

<!-- parksville <- bc_da %>%  -->
<!--   filter(cma_name == "Parksville ") -->

<!-- ###### Descriptive Statistics  -->

<!-- parksville %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   group_by(vandix_quintile) %>%  -->
<!--   summarise(n = n(), -->
<!--             road_length = sum(total_roads_km ), -->
<!--             casualty_claims = sum(n_casualty_claims) -->
<!--             ) %>%  -->
<!--   drop_na() %>%  -->
<!--   mutate(casualty_claims_rate = casualty_claims/road_length*100) %>%  -->
<!--   ggplot(aes(x=vandix_quintile,y = casualty_claims,group = 1)) +  -->
<!--   geom_point(size =2) +  -->
<!--   geom_line()  +  -->
<!--   theme_minimal() -->

<!-- ###### Maps -->

<!-- ggplot() +  -->
<!--   geom_sf(data = parksville, aes(fill = vandix_z_c,colour=vandix_z_c)) + -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_d(name = "VanDIX Score ", -->
<!--                      type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_d(name = "VanDIX Score ", -->
<!--                        type = "diverging", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = parksville, aes(fill = n_casualty_claims,colour=n_casualty_claims)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Insurance Claims", -->
<!--                      type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Insurance Claims", -->
<!--                        type = "aggregation", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->


<!-- ggplot() +  -->
<!--   geom_sf(data = parksville, aes(fill = total_roads_km,colour=total_roads_km)) +  -->
<!--   coord_sf(crs = "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs") +  -->
<!--   scale_fill_carto_c(name = "Kilometres of Road", -->
<!--                      type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   scale_colour_carto_c(name = "Kilometres of Road", -->
<!--                        type = "quantitative", palette = "Earth", direction = -1) +  -->
<!--   theme_void() -->

<!-- ##### Define Spatial Neighrbourhoods -->

<!-- parksville <- as(parksville, "Spatial") -->
<!-- parksville$ui <- 1:nrow(parksville@data) -->
<!-- coords <- coordinates(parksville) -->
<!-- parksville_nb <- poly2nb(parksville, queen = TRUE) -->
<!-- parksville_nb -->

<!-- plot(parksville, border = grey(0.5)) -->
<!-- plot(parksville_nb, -->
<!--      coords = coords, -->
<!--      add = TRUE, pch = 16, lwd = 2) -->

<!-- nb2INLA("parksville.adj", parksville_nb) -->
<!-- g <- inla.read.graph(filename = "parksville.adj") -->

<!-- descriptives %>%  -->
<!--   filter(cma=="Parksville ") %>%  -->
<!--   print(n = 100) -->

<!-- ####### Spatial Autocorrelation -->

<!-- listw <- nb2listw(parksville_nb,zero.policy = TRUE) -->
<!-- all_cc_mi <- moran.test(parksville$n_casualty_claims, listw,zero.policy = TRUE) -->
<!-- all_cc_mi$statistic -->
<!-- all_cc_mi$p.value %>% round(.,4) -->

<!-- cyc_cc_mi <- moran.test(parksville$n_cyclist_casualty_claims, listw,zero.policy = TRUE) -->
<!-- cyc_cc_mi$statistic -->
<!-- cyc_cc_mi$p.value %>% round(.,4) -->


<!-- pd_cc_mi <- moran.test(parksville$n_pedestrian_casualty_claims, listw,zero.policy = TRUE) -->
<!-- pd_cc_mi$statistic -->
<!-- pd_cc_mi$p.value %>% round(.,4) -->

<!-- ###### Spatial Models #####   -->

<!-- # Model Set 1: Total Casualty Claim Crashes -->

<!-- park_models_1 <- cma_models(parksville@data,"parksville","n_casualty_claims","vandix_z") -->
<!-- park_all <- clean_fixed_effects(park_models_1$fixed_effects) -->

<!-- # Model Set 2: Total Casualty Cyclist Claim Crashes -->

<!-- park_models_2 <- cma_models(parksville@data,"parksville","n_cyclist_casualty_claims","vandix_z") -->
<!-- park_cyclist <- clean_fixed_effects(park_models_2$fixed_effects) -->

<!-- # Model Set 3: Total Casualty Cyclist Claim Crashes -->

<!-- park_models_3 <- cma_models(parksville@data,"parksville","n_pedestrian_casualty_claims","vandix_z") -->
<!-- park_pedestrian <- clean_fixed_effects(park_models_3$fixed_effects) -->


<!-- park_results <- bind_rows(park_all %>% mutate(CMA = "Parksville",Outcome = "All Injury Claims"), -->
<!--                           park_cyclist %>% mutate(CMA = "Parksville", Outcome = "Cyclist Injury Claims"), -->
<!--                           park_pedestrian %>% mutate(CMA = "Parksville", Outcome = "Pedestrian Injury Claims") -->
<!-- ) %>%  -->
<!--   filter(variable == "vandix_z") %>%  -->
<!--   select(CMA,Outcome,everything()) -->





<!-- # Abstract -->

<!-- **Background**: Socioeconomic status (SES) has been shown to be assocaited with risk of traffic injury . The purpose of this study was to measure the association of neighbourhood SES on risk of motor-vehicle traffic injury in the province of British Columbia. -->

<!-- **Methods:** We aggregated the number of crashes captured by insurance claims crashes where at least one injury was recorded in each census Dissemination Area (DA) in the province over a five year period (2019-2023). We measured neighbourhood SES using the Vancouver Area Neighbourhood Deprivation Index (VANDIX) score using 2021 census data. Road network, built environment and population spatial data sets were compiled for factors that influence traffic exposure (i.e. the number of trips made by motor vehicle, bicycling and walking). We used Moran's I to quantify the degree and direction of spatial autocorrelation in crash counts by DA. For the top xx most populated CMA/CAs in the province we used a modified Besag, York and Mollie model (BYM2) to quantify the association between neighbourhood SES and counts of road traffic injuries, adjusting for spatial dependence in the data, for three different outcomes: motor vehicle injury crashes, bicycle-motor vehicle injury crashes and pedestrian-motor vehicle injury crashes. Integrated Nested Laplace Approximation (INLA) was used to estimate parameters. -->

<!-- **Results:** We found consistently strong positive associations between neighbourhood deprivation and road traffic injury crashes for almost all metropolitan areas in the province.  -->

<!-- # Background -->

<!-- # Materials and Methods -->

<!-- ## Vancouver Area Deprivation Index -->

<!-- To measure socioeconomic status we used a version of the VANDIX based on 2016 Census Data. The VANDIX was constructed from a 2005 survey of eighteen provincial medical health officers regarding socioeconomic factors such as housing and education that contribute to health status in the province. The officers were given a list of 21 indicators separated into seven categories. The 21 indicators were chosen because they reflect the conditions of social and material deprivation. They are also relevant when studying urban areas in BC and have been used to construct area-based deprivation indicators in the past. -->

<!-- ## ICBC Claims 2019-2023 -->

<!-- The Insurance Corporation of British Columbia (ICBC) is a universal auto-insurance provider for the province of British Columbia. We use publicly available ICBC claims data from 2015 -2019. The dataset includes crashes that involved a motor-vehicle in which an insurance claim was made, and thus does not include data on collisions that resulted from interactions with other road users (e.g., cyclists or pedestrians) or single-bicycle crashes (e.g., a collision with a stationary object). Many motor vehicle crashes go unreported, especially ones in which motor vehicle damage was limited. ICBC data include a binary descriptor of injury severity if at least one person was injured in the crash (casualty crash). We excluded crashes where no injury resulted (property damage only). -->

<!-- ## Built Environment and Population Characteristics Variables -->

<!-- We used the BC Digital Road Atlas to measure the road network within each DA. We stratified roads based on their classification of local, collector, arterial and highway/freeways. -->

<!-- The Canadian Active Living and Environment Index (Can-ALE) is a summary measure of connectivity, density, destinations and transit stops. Areas with a high Can-ALE class will have higher intersection density of roads and footpaths, higher dwelling density, higher density of points of interests (shops, parks, businesses) and higher density of transit stops. -->

<!-- The Canadian Bikeway Comfort and Safety (Can-BICS) metrics are area-level metrics that measure access to different types of bicycling infrastructure based on Open Street Map data.  -->

<!-- We use the Canadian census variables to measure areas with potentially more traffic and different modes by including the total employed population over 15 and the the proportion of the employed population whose main mode of commute is not a motor vehicle (walk, bicycle, public transportation or other). -->

<!-- Data Processing -->

<!-- ## Data Processing -->

<!-- We aggregated all data to the census unit of Dissemination Area. Dissemination Areas are the smallest geographic unit at which census data are disseminated by Statistics Canada and aim to capture between 400-700 people. As such the physical size of the units are larger for less populated areas. -->

<!-- We counted the number of crashes which resulted in an insurance claims that caused at least one injury within each Dissemination Area. Where crashes occurred Where crashes occurred on roads that form the border of 2 or more DAs (defined as occurring within 10m of the boundary of the DA) we randomly assign crashes with each bordering DA having equal probability of assignment. -->

<!-- ## Statistical Analysis -->

<!-- We evaluated the directionality and strength of spatial dependence in counts of insurance claims through Moran's I statistic for each crash type. -->

<!-- We calculated a crude incidence rate for each crash type based on length of roads within each dissemination area stratified by whether the DA was within a Census Metropolitan Area (Urban) or outside of one (Rural). -->

<!-- We quantified the association between neighbourhod SES and traffic injury incidence using Bayesian Poisson spatial Models. We used the modified Besag, York & Mollie (BYM2) model to take into account spatial correlation in the counts of insurance claims using Integrated Nested Laplace Approximation (INLA) to estimate the model parameters. -->

<!-- A queens contiguity definition of neighbourhod was used to define spatial neighborhoods. DAs with 0 neighbours were manually assigned the nearest DA as its neighbour.  -->

<!-- We specify a model where observed counts of traffic injury crashes $Y_i$ are conditionally independently Poisson distributed: -->

<!-- $$Y_i \| \theta_i \sim \text{Poisson}(\theta_i), i = 1,\ldots,n,  $$ -->

<!-- Where $\theta_i$: Mean count of traffic injuries in area $i$. The logarithm of $\theta_i$, is modeled as: -->

<!-- $$\log(\theta_i) = \alpha + \gamma D_i + \beta_1 X_{i1} + \ldots + \beta_7 X_{i7} + u_i + v_i$$ -->

<!-- -   $\alpha$: Intercept. -->
<!-- -   $\gamma$: Main coefficient of interest Vancouver Area Deprivation Index -->
<!-- -   $\beta_1, \ldots, \beta_7$: Coefficients for the adjustment covariates -->
<!-- -   $u_i$: Unstructured random effect for area $i$ -->
<!-- -   $v_i$: Spatially structured random effect for area $i$ -->

<!-- BYM2 has two hyperparameters, a precision and mixing parameter. The precision parameter controls the variability explained by a spatial effect. The mixing parameter distributes existing variability between unstructured ($u$) and structured model components($v$). The mixing parameter prior was set to (U = 0.5, = 2/3), which assumes the unstructured random effect accounts for more of the variability than the spatially structured effect. The precision parameter was set to (U = 0.2/0.31,  = 0.01). The BYM2 model is equal to an only spatial model when the mixing parameter is equal to 1 and and an only unstructured spatial noise when it's 0. -->


<!-- We created xx models based on Census Metropolitan Areas (CMA) or a Census Agglomeration Area (CA).  -->
<!-- - A CMA is formed by one or more adjacent municipalities centred on a population centre (known as the core).  -->
<!-- - A CMA must have a total population of at least 100,000, based on data from the current Census of Population Program, of which 50,000 or more must live in the core based on adjusted data from the previous Census of Population Program.  -->
<!-- - A CA must have a core population of at least 10,000 also based on data from the previous Census of Population Program. To be included in the CMA or CA, other adjacent municipalities must have a high degree of integration with the core, as measured by commuting flows derived from data on place of work from the previous Census Program. -->

<!-- For each region we fit three models to each crash type which included an unadjusted model, a minimally adjusted model that includes the log of the total length of roads and fully adjusted model that includes the log of the total length of roads and several other road network and built environment characteristics that we considered proxies for differences in traffic exposure holding length of roads constant. We chose to use the log of the total length of roads as a co-variate instead of an offset because the relationship was estimated to be non-linear, areas with more total roads had proportionately fewer incidences of crashes. -->

<!-- # Results  -->

<!-- ## Descriptive Statistics  -->

<!-- ```{r} -->

<!-- cma_stats <- bc_da %>% -->
<!--   st_drop_geometry() %>% -->
<!--   group_by(cma_name) %>% -->
<!--   summarise( -->
<!--     n_das = n(), -->
<!--     population = sum(population,na.rm=TRUE), -->
<!--     n_casualty_claims = sum(n_casualty_claims,na.rm = TRUE), -->
<!--     n_cyclist_casualty_claims = sum(n_casualty_claims,na.rm = TRUE), -->
<!--     n_pedestrian_casualty_claims = sum(n_pedestrian_casualty_claims,na.rm = TRUE), -->
<!--     total_length_of_road = sum(total_roads_km) %>% round(.,1), -->
<!--     mean_length_of_road = mean(total_roads_km) %>% round(.,1), -->
<!--     mean_vandix = mean(vandix,na.rm=TRUE) %>% round(.,1), -->
<!--     mean_length_of_road = mean(vandix,na.rm=TRUE) %>% round(.,1), -->



<!--     )  -->




<!--     "no_highschool_prevalance", -->
<!--     "unemployment_rate", -->
<!--     "hh_avg_income", -->
<!--     "participation_rate", -->
<!--     "university_degree_prevalance", -->
<!--     "lone_parent_fam_prevalence", -->
<!--     "home_owner_prevalence", -->
<!--     "vandix", -->
<!--     "roads_prop_highway_arterial", -->
<!--     "ale_index", -->
<!--     "canbics_index" -->

<!--         p_missing_vandix = round((sum(is.na(vandix))/N*100),1), -->
<!--     n_vandix_q4_q5 = sum( -->
<!--       vandix_quintile == "5 - Most Deprived" | -->
<!--         vandix_quintile == "4", -->
<!--       na.rm = TRUE -->
<!--     ), -->
<!--         prop_most_deprived = round(n_vandix_q4_q5 / N*100,1), -->
<!--     total_length_of_road = sum(total_roads_km) %>% round(.,1), -->
<!--     mean_length_of_road = mean(total_roads_km) %>% round(.,1)) %>% -->
<!--   arrange(desc(population)) -->

<!-- #   geom_point() +  -->
<!-- #   geom_smooth(method = "lm") -->

<!-- cd_stats %>%  -->
<!--   flextable() %>%  -->
<!--   set_header_labels( -->
<!--   values = list( -->
<!--         p_missing_vandix = "% Missing Vandix", -->

<!--     n_vandix_q4_q5 = "N VanDIX Quintile 4 or 5\n(More Deprived)", -->
<!--     prop_most_deprived = "% More Deprived", -->
<!--     total_length_of_road = "Total Kilometres of Road", -->
<!--     mean_length_of_road = "Average Kilometres of Road", -->
<!--     mean_remoteness_index = "Average Remoteness Index" -->
<!--   ) -->
<!-- ) %>%  autofit() -->


<!-- ``` -->





